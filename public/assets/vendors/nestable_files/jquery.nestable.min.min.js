/*!
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
(function(r,p,o,t){var q="ontouchstart" in p;var u=(function(){var a=o.createElement("div"),c=o.documentElement;if(!("pointerEvents" in a.style)){return false}a.style.pointerEvents="auto";a.style.pointerEvents="x";c.appendChild(a);var b=p.getComputedStyle&&p.getComputedStyle(a,"").pointerEvents==="auto";c.removeChild(a);return !!b})();var l=q?"touchstart":"mousedown",m=q?"touchmove":"mousemove",v=q?"touchend":"mouseup";eCancel=q?"touchcancel":"mouseup";var s={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,dropCallback:null};function n(a,b){this.w=r(p);this.el=r(a);this.options=r.extend({},s,b);this.init()}n.prototype={init:function(){var c=this;c.reset();c.el.data("nestable-group",this.options.group);c.placeEl=r('<div class="'+c.options.placeClass+'"/>');r.each(this.el.find(c.options.itemNodeName),function(f,e){c.setParent(r(e))});c.el.on("click","button",function(e){if(c.dragEl||(!q&&e.button!==0)){return}var f=r(e.currentTarget),g=f.data("action"),h=f.parent(c.options.itemNodeName);if(g==="collapse"){c.collapseItem(h)}if(g==="expand"){c.expandItem(h)}});var b=function(e){var f=r(e.target);if(!f.hasClass(c.options.handleClass)){if(f.closest("."+c.options.noDragClass).length){return}f=f.closest("."+c.options.handleClass)}if(!f.length||c.dragEl||(!q&&e.button!==0)||(q&&e.touches.length!==1)){return}e.preventDefault();c.dragStart(q?e.touches[0]:e)};var d=function(e){if(c.dragEl){e.preventDefault();c.dragMove(q?e.touches[0]:e)}};var a=function(e){if(c.dragEl){e.preventDefault();c.dragStop(q?e.touches[0]:e)}};if(q){c.el[0].addEventListener(l,b,false);p.addEventListener(m,d,false);p.addEventListener(v,a,false);p.addEventListener(eCancel,a,false)}else{c.el.on(l,b);c.w.on(m,d);c.w.on(v,a)}},serialize:function(){var a,c=0,b=this;step=function(d,f){var e=[],g=d.children(b.options.itemNodeName);g.each(function(){var j=r(this),h=r.extend({},j.data()),i=j.children(b.options.listNodeName);if(i.length){h.children=step(i,f+1)}e.push(h)});return e};a=step(b.el.find(b.options.listNodeName).first(),c);return a},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null;this.sourceRoot=null},expandItem:function(a){a.removeClass(this.options.collapsedClass);a.children('[data-action="expand"]').hide();a.children('[data-action="collapse"]').show();a.children(this.options.listNodeName).show()},collapseItem:function(a){var b=a.children(this.options.listNodeName);if(b.length){a.addClass(this.options.collapsedClass);a.children('[data-action="collapse"]').hide();a.children('[data-action="expand"]').show();a.children(this.options.listNodeName).hide()}},expandAll:function(){var a=this;a.el.find(a.options.itemNodeName).each(function(){a.expandItem(r(this))})},collapseAll:function(){var a=this;a.el.find(a.options.itemNodeName).each(function(){a.collapseItem(r(this))})},setParent:function(a){if(a.children(this.options.listNodeName).length){a.prepend(r(this.options.expandBtnHTML));a.prepend(r(this.options.collapseBtnHTML))}a.children('[data-action="expand"]').hide()},unsetParent:function(a){a.removeClass(this.options.collapsedClass);a.children("[data-action]").remove();a.children(this.options.listNodeName).remove()},dragStart:function(d){var a=this.mouse,e=r(d.target),f=e.closest(this.options.itemNodeName);this.sourceRoot=e.closest("."+this.options.rootClass);this.placeEl.css("height",f.height());a.offsetX=d.offsetX!==t?d.offsetX:d.pageX-e.offset().left;a.offsetY=d.offsetY!==t?d.offsetY:d.pageY-e.offset().top;a.startX=a.lastX=d.pageX;a.startY=a.lastY=d.pageY;this.dragRootEl=this.el;this.dragEl=r(o.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",f.width());f.after(this.placeEl);f[0].parentNode.removeChild(f[0]);f.appendTo(this.dragEl);r(o.body).append(this.dragEl);this.dragEl.css({left:d.pageX-a.offsetX,top:d.pageY-a.offsetY});var g,c,b=this.dragEl.find(this.options.itemNodeName);for(g=0;g<b.length;g++){c=r(b[g]).parents(this.options.listNodeName).length;if(c>this.dragDepth){this.dragDepth=c}}},dragStop:function(d){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]);this.placeEl.replaceWith(e);this.dragEl.remove();this.el.trigger("change");var b=e.parent().parent();var c=null;if(b!==null&&!b.is("."+this.options.rootClass)){c=b.data("id")}if(r.isFunction(this.options.dropCallback)){var a={sourceId:e.data("id"),destId:c,sourceEl:e,destParent:b,destRoot:e.closest("."+this.options.rootClass),sourceRoot:this.sourceRoot};this.options.dropCallback.call(this,a)}if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(z){var y,h,e,b,c,f=this.options,k=this.mouse;this.dragEl.css({left:z.pageX-k.offsetX,top:z.pageY-k.offsetY});k.lastX=k.nowX;k.lastY=k.nowY;k.nowX=z.pageX;k.nowY=z.pageY;k.distX=k.nowX-k.lastX;k.distY=k.nowY-k.lastY;k.lastDirX=k.dirX;k.lastDirY=k.dirY;k.dirX=k.distX===0?0:k.distX>0?1:-1;k.dirY=k.distY===0?0:k.distY>0?1:-1;var g=Math.abs(k.distX)>Math.abs(k.distY)?1:0;if(!k.moving){k.dirAx=g;k.moving=true;return}if(k.dirAx!==g){k.distAxX=0;k.distAxY=0}else{k.distAxX+=Math.abs(k.distX);if(k.dirX!==0&&k.dirX!==k.lastDirX){k.distAxX=0}k.distAxY+=Math.abs(k.distY);if(k.dirY!==0&&k.dirY!==k.lastDirY){k.distAxY=0}}k.dirAx=g;if(k.dirAx&&k.distAxX>=f.threshold){k.distAxX=0;e=this.placeEl.prev(f.itemNodeName);if(k.distX>0&&e.length&&!e.hasClass(f.collapsedClass)){y=e.find(f.listNodeName).last();c=this.placeEl.parents(f.listNodeName).length;if(c+this.dragDepth<=f.maxDepth){if(!y.length){y=r("<"+f.listNodeName+"/>").addClass(f.listClass);y.append(this.placeEl);e.append(y);this.setParent(e)}else{y=e.children(f.listNodeName).last();y.append(this.placeEl)}}}if(k.distX<0){b=this.placeEl.next(f.itemNodeName);if(!b.length){h=this.placeEl.parent();this.placeEl.closest(f.itemNodeName).after(this.placeEl);if(!h.children().length){this.unsetParent(h.parent())}}}}var d=false;if(!u){this.dragEl[0].style.visibility="hidden"}this.pointEl=r(o.elementFromPoint(z.pageX-o.body.scrollLeft,z.pageY-(p.pageYOffset||o.documentElement.scrollTop)));if(!u){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(f.handleClass)){this.pointEl=this.pointEl.parent(f.itemNodeName)}if(this.pointEl.hasClass(f.emptyClass)){d=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(f.itemClass)){return}}var a=this.pointEl.closest("."+f.rootClass),i=this.dragRootEl.data("nestable-id")!==a.data("nestable-id");if(!k.dirAx||i||d){if(i&&f.group!==a.data("nestable-group")){return}c=this.dragDepth-1+this.pointEl.parents(f.listNodeName).length;if(c>f.maxDepth){return}var j=z.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);h=this.placeEl.parent();if(d){y=r(o.createElement(f.listNodeName)).addClass(f.listClass);y.append(this.placeEl);this.pointEl.replaceWith(y)}else{if(j){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!h.children().length){this.unsetParent(h.parent())}if(!this.dragRootEl.find(f.itemNodeName).length){this.dragRootEl.append('<div class="'+f.emptyClass+'"/>')}if(i){this.dragRootEl=a;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};r.fn.nestable=function(c){var b=this,a=this;b.each(function(){var d=r(this).data("nestable");if(!d){r(this).data("nestable",new n(this,c));r(this).data("nestable-id",new Date().getTime())}else{if(typeof c==="string"&&typeof d[c]==="function"){a=d[c]()}}});return a||b}})(window.jQuery||window.Zepto,window,document);