/*! gridmanager - v0.2.2 - 2014-06-18
* http://neokoenig.github.io/jQuery-gridmanager/
* Copyright (c) 2014 Tom King; Licensed MIT */
(function(b){b.gridmanager=function(f,a){var e=this;e.$el=b(f);e.el=f;e.$el.data("gridmanager",e);e.init=function(){e.options=b.extend({},b.gridmanager.defaultOptions,a);e.log("INIT");e.rteControl("init");e.createCanvas();e.createControls();e.initControls();e.initCanvas();e.log("FINISHED")};e.createCanvas=function(){e.log("+ Create Canvas");var c=e.$el.html();e.$el.html("");b("<div/>",{id:e.options.canvasId,html:c}).appendTo(e.$el)};e.createControls=function(){e.log("+ Create Controls");var c=[];b.each(e.options.controlButtons,function(i,d){var j=e.generateButtonClass(d);c.push("<a title='Add Row "+j+"' class='"+e.options.controlButtonClass+" add"+j+"'><span class='"+e.options.controlButtonSpanClass+"'></span> "+j+"</a>");e.generateClickHandler(d)});e.$el.prepend(b("<div/>",{id:e.options.controlId,"class":e.options.gmClearClass}).prepend(b("<div/>",{"class":e.options.rowClass}).html(b("<div/>",{"class":e.options.colClass+12}).addClass(e.options.colAdditionalClass).html(b("<div/>",{id:"gm-addnew"}).addClass(e.options.gmBtnGroup).addClass(e.options.gmFloatLeft).html(c.join(""))).append(e.options.controlAppend))))};e.initControls=function(){var c=e.$el.find("#"+e.options.canvasId);e.log("+ InitControls Running");e.$el.on("click",".gm-preview",function(){if(e.status){e.deinitCanvas();b(this).parent().find(".gm-mode").prop("disabled",true)}else{e.initCanvas();b(this).parent().find(".gm-mode").prop("disabled",false)}b(this).toggleClass(e.options.gmDangerClass)}).on("click",".gm-mode",function(){if(e.mode==="visual"){e.deinitCanvas();c.html(b("<textarea/>").attr("cols",130).attr("rows",25).val(c.html()));e.mode="html";b(this).parent().find(".gm-preview").prop("disabled",true)}else{var d=c.find("textarea").val();c.html(d);e.initCanvas();e.mode="visual";b(this).parent().find(".gm-preview").prop("disabled",false)}b(this).toggleClass(e.options.gmDangerClass)}).on("click",".gm-editholder",function(){var d=b(this);if(!d.attr("contenteditable")){d.attr("contenteditable",true);e.rteControl("attach",d)}}).on("click","a.gm-save",function(){e.deinitCanvas();e.saveremote()}).on("click","a.gm-rowSettings",function(){var d=b(this).closest(e.options.rowSelector);var h=d.find(".gm-rowSettingsDrawer");if(h.length>0){h.remove()}else{d.prepend(e.generateRowSettings(d))}}).on("blur","input.gm-rowSettingsID",function(){var d=b(this).closest(e.options.rowSelector);d.attr("id",b(this).val())}).on("click",".gm-toggleRowClass",function(){var h=b(this).closest(e.options.rowSelector);var d=b(this).text().trim();h.toggleClass(d);if(h.hasClass(d)){b(this).addClass(e.options.gmDangerClass)}else{b(this).removeClass(e.options.gmDangerClass)}}).on("click","a.gm-addColumn",function(){b(this).parent().after(e.createCol(2))}).on("click","a.gm-colDecrease",function(){var h=b(this).closest("."+e.options.gmEditClass);var d=e.getColClass(h);if(d.colWidth>parseInt(e.options.colResizeStep,10)){d.colWidth=(parseInt(d.colWidth,10)-parseInt(e.options.colResizeStep,10));h.switchClass(d.colClass,e.options.colClass+d.colWidth,200)}}).on("click","a.gm-colIncrease",function(){var h=b(this).closest("."+e.options.gmEditClass);var d=e.getColClass(h);if(d.colWidth<e.options.colMax){d.colWidth=(parseInt(d.colWidth,10)+parseInt(e.options.colResizeStep,10));h.switchClass(d.colClass,e.options.colClass+d.colWidth,200)}}).on("click","a.gm-resetgrid",function(){c.html("");e.reset()}).on("click","a.gm-removeCol",function(){b(this).closest("."+e.options.gmEditClass).animate({opacity:"hide",width:"hide",height:"hide"},400,function(){this.remove()})}).on("click","a.gm-removeRow",function(){b(this).closest("."+e.options.gmEditClass).animate({opacity:"hide",height:"hide"},400,function(){this.remove()})}).on("click","a.gm-resetgrid, a.gm-remove, a.gm-save, button.gm-preview, a.gm-viewsource, a.gm-addColumn, a.gm-colDecrease, a.gm-colIncrease",function(d){e.log("Clicked: "+b.grep((this).className.split(" "),function(h){return h.indexOf("gm-")===0}).join());d.preventDefault()})};e.getColClass=function(h){var c=b.grep(h.attr("class").split(" "),function(g){return g.indexOf(e.options.colClass)===0}).join();var d=c.replace(e.options.colClass,"");return{colClass:c,colWidth:d}};e.initCanvas=function(){var h=e.$el.find("#"+e.options.canvasId);var c=h.find(e.options.colSelector);var d=h.find(e.options.rowSelector);e.log("+ InitCanvas Running");e.$el.find("#gm-addnew").show();e.activateRows(d);e.activateCols(c);h.sortable({items:e.options.rowSelector,axis:"y",placeholder:e.options.rowSortingClass,handle:"."+e.options.gmToolClass,forcePlaceholderSize:true,opacity:0.7,revert:true,tolerance:"pointer",cursor:"move"});d.sortable({items:e.options.colSelector,axis:"x",handle:"."+e.options.gmToolClass,forcePlaceholderSize:true,opacity:0.7,revert:true,tolerance:"pointer",cursor:"move"});e.status=true;e.mode="visual"};e.deinitCanvas=function(){var h=e.$el.find("#"+e.options.canvasId);var c=h.find(e.options.colSelector);var d=h.find(e.options.rowSelector);e.log("- deInitCanvas Running");e.$el.find("#gm-addnew").hide();e.deactivateRows(d);e.deactivateCols(c);e.cleanup();e.status=false};e.saveremote=function(){var c=e.$el.find("#"+e.options.canvasId);b.ajax({type:"POST",url:e.options.remoteURL,data:c.html()});e.log("Save Function Called")};e.activateRows=function(c){e.log("++ Activate Rows");c.addClass(e.options.gmEditClass).prepend(e.toolFactory(e.options.rowButtonsPrepend)).append(e.toolFactory(e.options.rowButtonsAppend))};e.deactivateRows=function(c){e.log("-- DeActivate Rows");c.removeClass(e.options.gmEditClass).removeClass("ui-sortable").removeAttr("style")};e.createRow=function(d){var c=b("<div/>",{"class":e.options.rowClass+" "+e.options.gmEditClass});b.each(d,function(j,i){c.append(e.createCol(i))});c.prepend(e.toolFactory(e.options.rowButtonsPrepend)).append(e.toolFactory(e.options.rowButtonsPrepend));e.log("++ Created Row");return c};e.generateRowSettings=function(c){var d=[];b.each(e.options.rowCustomClasses,function(i,g){var l=b("<button/>").addClass("gm-toggleRowClass").addClass(e.options.controlButtonClass).append(b("<span/>").addClass(e.options.controlButtonSpanClass)).append(" "+g);if(c.hasClass(g)){l.addClass(e.options.gmDangerClass)}d.push(l[0].outerHTML)});var h=b("<div/>").addClass("gm-rowSettingsDrawer").addClass(e.options.gmToolClass).addClass(e.options.gmClearClass).prepend(b("<div />").addClass(e.options.gmBtnGroup).addClass(e.options.gmFloatLeft).html(d.join(""))).append(b("<div />").addClass("pull-right").html(b("<label />").html("Row ID ").append(b("<input>").addClass("gm-rowSettingsID").attr({type:"text",placeholder:"Row ID",value:c.attr("id")}))));return h[0].outerHTML};e.activateCols=function(c){c.addClass(e.options.gmEditClass);b.each(c,function(m,d){var n=e.toolFactory(e.options.colButtonsPrepend)+"<div class='gm-editholder'>";var p="</div>"+e.toolFactory(e.options.colButtonsAppend);var o=b(d).html();var i=b.grep((d).className.split(" "),function(g){return g.indexOf(e.options.colClass)===0}).join();b(d).html(n+o+p).find(".gm-handle-col").attr("title","Move "+i)});e.log("++ Activate Cols Ran")};e.deactivateCols=function(c){c.removeClass(e.options.gmEditClass);b.each(c,function(i,d){var j=b(d).find(".gm-editholder").html();b(d).html(j)});e.log("-- deActivate Cols Ran")};e.createCol=function(c){var d=b("<div/>").addClass(e.options.colClass+c).addClass(e.options.gmEditClass).addClass(e.options.colAdditionalClass).html(e.toolFactory(e.options.colButtonsPrepend)).append(b("<div/>",{"class":"gm-editholder"}).html("<p>Awaiting Content</p>").append(e.toolFactory(e.options.colButtonsAppend)));e.log("++ Created Column "+c);return d};e.toolFactory=function(d){var c=b("<div/>").addClass(e.options.gmToolClass).addClass(e.options.gmClearClass).html(e.buttonFactory(d));return c[0].outerHTML};e.buttonFactory=function(c){var d=[];b.each(c,function(j,i){d.push("<"+i.element+" title='"+i.title+"' class='"+i.btnClass+"'><span class='"+i.iconClass+"'></span>&nbsp;</"+i.element+"> ")});return d.join("")};e.generateButtonClass=function(d){var c="";b.each(d,function(j,i){c=c+"-"+i});return c};e.generateClickHandler=function(h){var c="a.add"+e.generateButtonClass(h);var d=e.$el.find("#"+e.options.canvasId);e.$el.on("click",c,function(g){e.log("Clicked "+c);d.prepend(e.createRow(h));e.reset();g.preventDefault()})};e.rteControl=function(c,d){e.log("RTE "+e.options.rte+" "+c);switch(c){case"init":if(typeof window.CKEDITOR!=="undefined"){e.options.rte="ckeditor";e.log("++ CKEDITOR Found");window.CKEDITOR.disableAutoInline=true}if(typeof window.tinymce!=="undefined"){e.options.rte="tinymce";e.log("++ TINYMCE Found")}break;case"attach":switch(e.options.rte){case"tinymce":if(!(d).hasClass("mce-content-body")){d.tinymce(e.options.tinymce.config)}break;case"ckeditor":b(d).ckeditor(e.options.ckeditor);break;default:e.log("No RTE specified for attach")}break;case"stop":switch(e.options.rte){case"tinymce":window.tinymce.remove();e.log("-- TinyMCE destroyed");break;case"ckeditor":for(var h in window.CKEDITOR.instances){window.CKEDITOR.instances[h].destroy()}e.log("-- CKEDITOR destroyed");break;default:e.log("No RTE specified for stop")}break;default:e.log("No RTE Action specified")}};e.reset=function(){e.log("~~RESET~~");e.deinitCanvas();e.initCanvas()};e.cleanup=function(){var c=e.$el.find("#"+e.options.canvasId);c.find(e.options.colSelector).removeAttr("style").removeAttr("spellcheck").removeAttr("id").removeClass("mce-content-body").end().find("img").removeAttr("style").addClass("img-responsive").removeAttr("data-cke-saved-src").removeAttr("data-mce-src").end().find("."+e.options.gmToolClass).remove();e.rteControl("stop");e.log("~~Cleanup Ran~~")};e.log=function(c){if(e.options.debug){if((window.console!==undefined)){window.console.log(c)}}};e.htmlEncode=function(c){if(c){return jQuery("<pre />").text(c).html()}else{return""}};e.init()};b.gridmanager.defaultOptions={debug:0,remoteURL:"/replace-with-your-url",canvasId:"gm-canvas",controlId:"gm-controls",controlButtons:[[12],[6,6],[4,4,4],[3,3,3,3],[2,2,2,2,2,2],[2,8,2],[4,8],[8,4]],controlButtonClass:"btn  btn-xs  btn-primary",controlButtonSpanClass:"glyphicon glyphicon-plus-sign",controlAppend:"<div class='btn-group pull-right'><button title='Edit Source Code' type='button' class='btn btn-xs btn-primary gm-mode'><span class='glyphicon glyphicon-chevron-left'></span><span class='glyphicon glyphicon-chevron-right'></span></button><button title='Preview' type='button' class='btn btn-xs btn-primary gm-preview'><span class='glyphicon glyphicon-eye-open'></span></button><button type='button' class='btn  btn-xs  btn-primary dropdown-toggle' data-toggle='dropdown'><span class='caret'></span><span class='sr-only'>Toggle Dropdown</span></button><ul class='dropdown-menu' role='menu'><li><a title='Save'  href='#' class='gm-save'><span class='glyphicon glyphicon-ok'></span> Save</a></li><li><a title='Reset Grid' href='#' class='gm-resetgrid'><span class='glyphicon glyphicon-trash'></span> Reset</a></li></ul></div>",gmEditClass:"gm-editing",gmToolClass:"gm-tools",gmClearClass:"clearfix",gmFloatLeft:"pull-left",gmFloatRight:"pull-right",gmBtnGroup:"btn-group",gmDangerClass:"btn-danger",rowClass:"row",rowSelector:"div.row",rowSortingClass:"bg-warning",rowButtonsPrepend:[{title:"New Column",element:"a",btnClass:"gm-addColumn pull-left  ",iconClass:"glyphicon glyphicon-plus"},{title:"Row Settings",element:"a",btnClass:"pull-right gm-rowSettings",iconClass:"glyphicon glyphicon-cog"}],rowButtonsAppend:[{title:"Remove row",element:"a",btnClass:"pull-right gm-removeRow",iconClass:"glyphicon glyphicon-trash"}],rowSettingControls:"Reserved for future use",rowCustomClasses:["example-class","test-class"],colClass:"col-md-",colSelector:"div[class*=col-]",colAdditionalClass:"",colButtonsPrepend:[{title:"Make Column Narrower",element:"a",btnClass:"gm-colDecrease pull-left",iconClass:"glyphicon glyphicon-minus-sign"},{title:"Make Column Wider",element:"a",btnClass:"gm-colIncrease pull-left",iconClass:"glyphicon glyphicon-plus-sign"}],colButtonsAppend:[{title:"Remove Column",element:"a",btnClass:"pull-right gm-removeCol",iconClass:"glyphicon glyphicon-trash"}],colMax:12,colResizeStep:1,tinymce:{config:{inline:true,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"}},ckeditor:{customConfig:""}};b.fn.gridmanager=function(a){return this.each(function(){(new b.gridmanager(this,a))})}})(jQuery);