/*! gridmanager - v0.2.2 - 2014-06-18
* http://neokoenig.github.io/jQuery-gridmanager/
* Copyright (c) 2014 Tom King; Licensed MIT */
(function(a){a.gridmanager=function(c,b){var d=this;d.$el=a(c);d.el=c;d.$el.data("gridmanager",d);d.init=function(){d.options=a.extend({},a.gridmanager.defaultOptions,b);d.log("INIT");d.rteControl("init");d.createCanvas();d.createControls();d.initControls();d.initCanvas();d.log("FINISHED")};d.createCanvas=function(){d.log("+ Create Canvas");var e=d.$el.html();d.$el.html("");a("<div/>",{id:d.options.canvasId,html:e}).appendTo(d.$el)};d.createControls=function(){d.log("+ Create Controls");var e=[];a.each(d.options.controlButtons,function(g,h){var f=d.generateButtonClass(h);e.push("<a title='Add Row "+f+"' class='"+d.options.controlButtonClass+" add"+f+"'><span class='"+d.options.controlButtonSpanClass+"'></span> "+f+"</a>");d.generateClickHandler(h)});d.$el.prepend(a("<div/>",{id:d.options.controlId,"class":d.options.gmClearClass}).prepend(a("<div/>",{"class":d.options.rowClass}).html(a("<div/>",{"class":d.options.colClass+12}).addClass(d.options.colAdditionalClass).html(a("<div/>",{id:"gm-addnew"}).addClass(d.options.gmBtnGroup).addClass(d.options.gmFloatLeft).html(e.join(""))).append(d.options.controlAppend))))};d.initControls=function(){var e=d.$el.find("#"+d.options.canvasId);d.log("+ InitControls Running");d.$el.on("click",".gm-preview",function(){if(d.status){d.deinitCanvas();a(this).parent().find(".gm-mode").prop("disabled",true)}else{d.initCanvas();a(this).parent().find(".gm-mode").prop("disabled",false)}a(this).toggleClass(d.options.gmDangerClass)}).on("click",".gm-mode",function(){if(d.mode==="visual"){d.deinitCanvas();e.html(a("<textarea/>").attr("cols",130).attr("rows",25).val(e.html()));d.mode="html";a(this).parent().find(".gm-preview").prop("disabled",true)}else{var f=e.find("textarea").val();e.html(f);d.initCanvas();d.mode="visual";a(this).parent().find(".gm-preview").prop("disabled",false)}a(this).toggleClass(d.options.gmDangerClass)}).on("click",".gm-editholder",function(){var f=a(this);if(!f.attr("contenteditable")){f.attr("contenteditable",true);d.rteControl("attach",f)}}).on("click","a.gm-save",function(){d.deinitCanvas();d.saveremote()}).on("click","a.gm-rowSettings",function(){var g=a(this).closest(d.options.rowSelector);var f=g.find(".gm-rowSettingsDrawer");if(f.length>0){f.remove()}else{g.prepend(d.generateRowSettings(g))}}).on("blur","input.gm-rowSettingsID",function(){var f=a(this).closest(d.options.rowSelector);f.attr("id",a(this).val())}).on("click",".gm-toggleRowClass",function(){var f=a(this).closest(d.options.rowSelector);var g=a(this).text().trim();f.toggleClass(g);if(f.hasClass(g)){a(this).addClass(d.options.gmDangerClass)}else{a(this).removeClass(d.options.gmDangerClass)}}).on("click","a.gm-addColumn",function(){a(this).parent().after(d.createCol(2))}).on("click","a.gm-colDecrease",function(){var f=a(this).closest("."+d.options.gmEditClass);var g=d.getColClass(f);if(g.colWidth>parseInt(d.options.colResizeStep,10)){g.colWidth=(parseInt(g.colWidth,10)-parseInt(d.options.colResizeStep,10));f.switchClass(g.colClass,d.options.colClass+g.colWidth,200)}}).on("click","a.gm-colIncrease",function(){var f=a(this).closest("."+d.options.gmEditClass);var g=d.getColClass(f);if(g.colWidth<d.options.colMax){g.colWidth=(parseInt(g.colWidth,10)+parseInt(d.options.colResizeStep,10));f.switchClass(g.colClass,d.options.colClass+g.colWidth,200)}}).on("click","a.gm-resetgrid",function(){e.html("");d.reset()}).on("click","a.gm-removeCol",function(){a(this).closest("."+d.options.gmEditClass).animate({opacity:"hide",width:"hide",height:"hide"},400,function(){this.remove()})}).on("click","a.gm-removeRow",function(){a(this).closest("."+d.options.gmEditClass).animate({opacity:"hide",height:"hide"},400,function(){this.remove()})}).on("click","a.gm-resetgrid, a.gm-remove, a.gm-save, button.gm-preview, a.gm-viewsource, a.gm-addColumn, a.gm-colDecrease, a.gm-colIncrease",function(f){d.log("Clicked: "+a.grep((this).className.split(" "),function(g){return g.indexOf("gm-")===0}).join());f.preventDefault()})};d.getColClass=function(e){var g=a.grep(e.attr("class").split(" "),function(h){return h.indexOf(d.options.colClass)===0}).join();var f=g.replace(d.options.colClass,"");return{colClass:g,colWidth:f}};d.initCanvas=function(){var e=d.$el.find("#"+d.options.canvasId);var g=e.find(d.options.colSelector);var f=e.find(d.options.rowSelector);d.log("+ InitCanvas Running");d.$el.find("#gm-addnew").show();d.activateRows(f);d.activateCols(g);e.sortable({items:d.options.rowSelector,axis:"y",placeholder:d.options.rowSortingClass,handle:"."+d.options.gmToolClass,forcePlaceholderSize:true,opacity:0.7,revert:true,tolerance:"pointer",cursor:"move"});f.sortable({items:d.options.colSelector,axis:"x",handle:"."+d.options.gmToolClass,forcePlaceholderSize:true,opacity:0.7,revert:true,tolerance:"pointer",cursor:"move"});d.status=true;d.mode="visual"};d.deinitCanvas=function(){var e=d.$el.find("#"+d.options.canvasId);var g=e.find(d.options.colSelector);var f=e.find(d.options.rowSelector);d.log("- deInitCanvas Running");d.$el.find("#gm-addnew").hide();d.deactivateRows(f);d.deactivateCols(g);d.cleanup();d.status=false};d.saveremote=function(){var e=d.$el.find("#"+d.options.canvasId);a.ajax({type:"POST",url:d.options.remoteURL,data:e.html()});d.log("Save Function Called")};d.activateRows=function(e){d.log("++ Activate Rows");e.addClass(d.options.gmEditClass).prepend(d.toolFactory(d.options.rowButtonsPrepend)).append(d.toolFactory(d.options.rowButtonsAppend))};d.deactivateRows=function(e){d.log("-- DeActivate Rows");e.removeClass(d.options.gmEditClass).removeClass("ui-sortable").removeAttr("style")};d.createRow=function(e){var f=a("<div/>",{"class":d.options.rowClass+" "+d.options.gmEditClass});a.each(e,function(g,h){f.append(d.createCol(h))});f.prepend(d.toolFactory(d.options.rowButtonsPrepend)).append(d.toolFactory(d.options.rowButtonsPrepend));d.log("++ Created Row");return f};d.generateRowSettings=function(g){var f=[];a.each(d.options.rowCustomClasses,function(j,k){var h=a("<button/>").addClass("gm-toggleRowClass").addClass(d.options.controlButtonClass).append(a("<span/>").addClass(d.options.controlButtonSpanClass)).append(" "+k);if(g.hasClass(k)){h.addClass(d.options.gmDangerClass)}f.push(h[0].outerHTML)});var e=a("<div/>").addClass("gm-rowSettingsDrawer").addClass(d.options.gmToolClass).addClass(d.options.gmClearClass).prepend(a("<div />").addClass(d.options.gmBtnGroup).addClass(d.options.gmFloatLeft).html(f.join(""))).append(a("<div />").addClass("pull-right").html(a("<label />").html("Row ID ").append(a("<input>").addClass("gm-rowSettingsID").attr({type:"text",placeholder:"Row ID",value:g.attr("id")}))));return e[0].outerHTML};d.activateCols=function(e){e.addClass(d.options.gmEditClass);a.each(e,function(j,l){var h=d.toolFactory(d.options.colButtonsPrepend)+"<div class='gm-editholder'>";var f="</div>"+d.toolFactory(d.options.colButtonsAppend);var g=a(l).html();var k=a.grep((l).className.split(" "),function(i){return i.indexOf(d.options.colClass)===0}).join();a(l).html(h+g+f).find(".gm-handle-col").attr("title","Move "+k)});d.log("++ Activate Cols Ran")};d.deactivateCols=function(e){e.removeClass(d.options.gmEditClass);a.each(e,function(g,h){var f=a(h).find(".gm-editholder").html();a(h).html(f)});d.log("-- deActivate Cols Ran")};d.createCol=function(f){var e=a("<div/>").addClass(d.options.colClass+f).addClass(d.options.gmEditClass).addClass(d.options.colAdditionalClass).html(d.toolFactory(d.options.colButtonsPrepend)).append(a("<div/>",{"class":"gm-editholder"}).html("<p>Awaiting Content</p>").append(d.toolFactory(d.options.colButtonsAppend)));d.log("++ Created Column "+f);return e};d.toolFactory=function(e){var f=a("<div/>").addClass(d.options.gmToolClass).addClass(d.options.gmClearClass).html(d.buttonFactory(e));return f[0].outerHTML};d.buttonFactory=function(f){var e=[];a.each(f,function(g,h){e.push("<"+h.element+" title='"+h.title+"' class='"+h.btnClass+"'><span class='"+h.iconClass+"'></span>&nbsp;</"+h.element+"> ")});return e.join("")};d.generateButtonClass=function(e){var f="";a.each(e,function(g,h){f=f+"-"+h});return f};d.generateClickHandler=function(e){var g="a.add"+d.generateButtonClass(e);var f=d.$el.find("#"+d.options.canvasId);d.$el.on("click",g,function(h){d.log("Clicked "+g);f.prepend(d.createRow(e));d.reset();h.preventDefault()})};d.rteControl=function(g,f){d.log("RTE "+d.options.rte+" "+g);switch(g){case"init":if(typeof window.CKEDITOR!=="undefined"){d.options.rte="ckeditor";d.log("++ CKEDITOR Found");window.CKEDITOR.disableAutoInline=true}if(typeof window.tinymce!=="undefined"){d.options.rte="tinymce";d.log("++ TINYMCE Found")}break;case"attach":switch(d.options.rte){case"tinymce":if(!(f).hasClass("mce-content-body")){f.tinymce(d.options.tinymce.config)}break;case"ckeditor":a(f).ckeditor(d.options.ckeditor);break;default:d.log("No RTE specified for attach")}break;case"stop":switch(d.options.rte){case"tinymce":window.tinymce.remove();d.log("-- TinyMCE destroyed");break;case"ckeditor":for(var e in window.CKEDITOR.instances){window.CKEDITOR.instances[e].destroy()}d.log("-- CKEDITOR destroyed");break;default:d.log("No RTE specified for stop")}break;default:d.log("No RTE Action specified")}};d.reset=function(){d.log("~~RESET~~");d.deinitCanvas();d.initCanvas()};d.cleanup=function(){var e=d.$el.find("#"+d.options.canvasId);e.find(d.options.colSelector).removeAttr("style").removeAttr("spellcheck").removeAttr("id").removeClass("mce-content-body").end().find("img").removeAttr("style").addClass("img-responsive").removeAttr("data-cke-saved-src").removeAttr("data-mce-src").end().find("."+d.options.gmToolClass).remove();d.rteControl("stop");d.log("~~Cleanup Ran~~")};d.log=function(e){if(d.options.debug){if((window.console!==undefined)){window.console.log(e)}}};d.htmlEncode=function(e){if(e){return jQuery("<pre />").text(e).html()}else{return""}};d.init()};a.gridmanager.defaultOptions={debug:0,remoteURL:"/replace-with-your-url",canvasId:"gm-canvas",controlId:"gm-controls",controlButtons:[[12],[6,6],[4,4,4],[3,3,3,3],[2,2,2,2,2,2],[2,8,2],[4,8],[8,4]],controlButtonClass:"btn  btn-xs  btn-primary",controlButtonSpanClass:"glyphicon glyphicon-plus-sign",controlAppend:"<div class='btn-group pull-right'><button title='Edit Source Code' type='button' class='btn btn-xs btn-primary gm-mode'><span class='glyphicon glyphicon-chevron-left'></span><span class='glyphicon glyphicon-chevron-right'></span></button><button title='Preview' type='button' class='btn btn-xs btn-primary gm-preview'><span class='glyphicon glyphicon-eye-open'></span></button><button type='button' class='btn  btn-xs  btn-primary dropdown-toggle' data-toggle='dropdown'><span class='caret'></span><span class='sr-only'>Toggle Dropdown</span></button><ul class='dropdown-menu' role='menu'><li><a title='Save'  href='#' class='gm-save'><span class='glyphicon glyphicon-ok'></span> Save</a></li><li><a title='Reset Grid' href='#' class='gm-resetgrid'><span class='glyphicon glyphicon-trash'></span> Reset</a></li></ul></div>",gmEditClass:"gm-editing",gmToolClass:"gm-tools",gmClearClass:"clearfix",gmFloatLeft:"pull-left",gmFloatRight:"pull-right",gmBtnGroup:"btn-group",gmDangerClass:"btn-danger",rowClass:"row",rowSelector:"div.row",rowSortingClass:"bg-warning",rowButtonsPrepend:[{title:"New Column",element:"a",btnClass:"gm-addColumn pull-left  ",iconClass:"glyphicon glyphicon-plus"},{title:"Row Settings",element:"a",btnClass:"pull-right gm-rowSettings",iconClass:"glyphicon glyphicon-cog"}],rowButtonsAppend:[{title:"Remove row",element:"a",btnClass:"pull-right gm-removeRow",iconClass:"glyphicon glyphicon-trash"}],rowSettingControls:"Reserved for future use",rowCustomClasses:["example-class","test-class"],colClass:"col-md-",colSelector:"div[class*=col-]",colAdditionalClass:"",colButtonsPrepend:[{title:"Make Column Narrower",element:"a",btnClass:"gm-colDecrease pull-left",iconClass:"glyphicon glyphicon-minus-sign"},{title:"Make Column Wider",element:"a",btnClass:"gm-colIncrease pull-left",iconClass:"glyphicon glyphicon-plus-sign"}],colButtonsAppend:[{title:"Remove Column",element:"a",btnClass:"pull-right gm-removeCol",iconClass:"glyphicon glyphicon-trash"}],colMax:12,colResizeStep:1,tinymce:{config:{inline:true,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"}},ckeditor:{customConfig:""}};a.fn.gridmanager=function(b){return this.each(function(){(new a.gridmanager(this,b))})}})(jQuery);