var Dataset=(function(){var c={thumbprint:"thumbprint",protocol:"protocol",itemHash:"itemHash",adjacencyList:"adjacencyList"};function b(d){utils.bindAll(this);if(utils.isString(d.template)&&!d.engine){$.error("no template engine specified")}if(!d.local&&!d.prefetch&&!d.remote){$.error("one of local, prefetch, or remote is required")}this.name=d.name||utils.getUniqueId();this.limit=d.limit||5;this.minLength=d.minLength||1;this.header=d.header;this.footer=d.footer;this.valueKey=d.valueKey||"value";this.template=a(d.template,d.engine,this.valueKey);this.local=d.local;this.prefetch=d.prefetch;this.remote=d.remote;this.itemHash={};this.adjacencyList={};this.storage=d.name?new PersistentStorage(d.name):null}utils.mixin(b.prototype,{_processLocalData:function(d){this._mergeProcessedData(this._processData(d))},_loadPrefetchData:function(e){var h=this,m=VERSION+(e.thumbprint||""),k,f,i,d,g,l;if(this.storage){k=this.storage.get(c.thumbprint);f=this.storage.get(c.protocol);i=this.storage.get(c.itemHash);d=this.storage.get(c.adjacencyList)}g=k!==m||f!==utils.getProtocol();e=utils.isString(e)?{url:e}:e;e.ttl=utils.isNumber(e.ttl)?e.ttl:24*60*60*1000;if(i&&d&&!g){this._mergeProcessedData({itemHash:i,adjacencyList:d});l=$.Deferred().resolve()}else{l=$.getJSON(e.url).done(j)}return l;function j(r){var q=e.filter?e.filter(r):r,p=h._processData(q),n=p.itemHash,o=p.adjacencyList;if(h.storage){h.storage.set(c.itemHash,n,e.ttl);h.storage.set(c.adjacencyList,o,e.ttl);h.storage.set(c.thumbprint,m,e.ttl);h.storage.set(c.protocol,utils.getProtocol(),e.ttl)}h._mergeProcessedData(p)}},_transformDatum:function(d){var f=utils.isString(d)?d:d[this.valueKey],g=d.tokens||utils.tokenizeText(f),e={value:f,tokens:g};if(utils.isString(d)){e.datum={};e.datum[this.valueKey]=d}else{e.datum=d}e.tokens=utils.filter(e.tokens,function(h){return !utils.isBlankString(h)});e.tokens=utils.map(e.tokens,function(h){return h.toLowerCase()});return e},_processData:function(g){var f=this,d={},e={};utils.each(g,function(j,h){var k=f._transformDatum(h),l=utils.getUniqueId(k.value);d[l]=k;utils.each(k.tokens,function(n,m){var p=m.charAt(0),o=e[p]||(e[p]=[l]);!~utils.indexOf(o,l)&&o.push(l)})});return{itemHash:d,adjacencyList:e}},_mergeProcessedData:function(d){var e=this;utils.mixin(this.itemHash,d.itemHash);utils.each(d.adjacencyList,function(h,g){var f=e.adjacencyList[h];e.adjacencyList[h]=f?f.concat(g):g})},_getLocalSuggestions:function(i){var h=this,g=[],e=[],f,d=[];utils.each(i,function(k,j){var l=j.charAt(0);!~utils.indexOf(g,l)&&g.push(l)});utils.each(g,function(j,k){var l=h.adjacencyList[k];if(!l){return false}e.push(l);if(!f||l.length<f.length){f=l}});if(e.length<g.length){return[]}utils.each(f,function(j,n){var l=h.itemHash[n],m,k;m=utils.every(e,function(o){return ~utils.indexOf(o,n)});k=m&&utils.every(i,function(o){return utils.some(l.tokens,function(p){return p.indexOf(o)===0})});k&&d.push(l)});return d},initialize:function(){var d;this.local&&this._processLocalData(this.local);this.transport=this.remote?new Transport(this.remote):null;d=this.prefetch?this._loadPrefetchData(this.prefetch):$.Deferred().resolve();this.local=this.prefetch=this.remote=null;this.initialize=function(){return d};return d},getSuggestions:function(i,e){var h=this,g,d,f=false;if(i.length<this.minLength){return}g=utils.tokenizeQuery(i);d=this._getLocalSuggestions(g).slice(0,this.limit);if(d.length<this.limit&&this.transport){f=this.transport.get(i,j)}!f&&e&&e(d);function j(k){d=d.slice(0);utils.each(k,function(n,m){var o=h._transformDatum(m),l;l=utils.some(d,function(p){return o.value===p.value});!l&&d.push(o);return d.length<h.limit});e&&e(d)}}});return b;function a(g,f,h){var e,d;if(utils.isFunction(g)){e=g}else{if(utils.isString(g)){d=f.compile(g);e=utils.bind(d.render,d)}else{e=function(i){return"<p>"+i[h]+"</p>"}}}return e}})();