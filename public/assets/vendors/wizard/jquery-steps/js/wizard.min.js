(function(b){b.fn.wizard=function(c){return new Wizard(this,c)};b.fn.wizard.logging=false;var a=function(g,d,c,f,e){this.wizard=g;this.index=c;this.prev=f;this.next=e;this.el=d;this.title=d.find("h3").first().text();this.name=d.data("cardname")||this.title;this.nav=this._createNavElement(this.title,c);this._disabled=false;this._loaded=false;this._events={}};a.prototype={select:function(){this.log("selecting");if(!this.isSelected()){this.nav.addClass("active");this.el.show();if(!this._loaded){this.trigger("loaded");this.reload()}this.trigger("selected")}var c=this.wizard;c.backButton.toggleClass("disabled",this.index==0);if(this.index>=c._cards.length-1){this.log("on last card, changing next button to submit");c.changeNextButton(c.args.buttons.submitText,"btn-success");c._readyToSubmit=true;c.trigger("readySubmit")}else{c._readyToSubmit=false;c.changeNextButton(c.args.buttons.nextText,"btn-primary")}return this},_createNavElement:function(e,f){var c=b('<li class="wizard-nav-item"></li>');var d=b('<a class="wizard-nav-link"></a>');d.data("navindex",f);c.append(d);d.append('<span class="glyphicon glyphicon-chevron-right"></span> ');d.append(e);return c},markVisited:function(){this.log("marking as visited");this.nav.addClass("already-visited");this.trigger("markVisited");return this},unmarkVisited:function(){this.log("unmarking as visited");this.nav.removeClass("already-visited");this.trigger("unmarkVisited");return this},deselect:function(){this.nav.removeClass("active");this.el.hide();this.trigger("deselect");return this},enable:function(){this.log("enabling");this.nav.addClass("active");this._disabled=false;this.trigger("enabled");return this},disable:function(c){this.log("disabling");this._disabled=true;this.nav.removeClass("active already-visited");if(c){this.el.hide()}this.trigger("disabled");return this},isDisabled:function(){return this._disabled},alreadyVisited:function(){return this.nav.hasClass("already-visited")},isSelected:function(){return this.nav.hasClass("active")},reload:function(){this._loaded=true;this.trigger("reload");return this},on:function(){return this.wizard.on.apply(this,arguments)},trigger:function(){this.callListener("on"+arguments[0]);return this.wizard.trigger.apply(this,arguments)},toggleAlert:function(e,c){this.log("toggling alert to: "+c);c=typeof(c)=="undefined"?true:c;if(c){this.trigger("showAlert")}else{this.trigger("hideAlert")}var f;var d=this.el.children("h3").first().next("div.alert");if(d.length==0){if(!c){return this}this.log("couldn't find existing alert div, creating one");f=b("<div />");f.addClass("alert");f.addClass("hide");f.insertAfter(this.el.find("h3").first())}else{this.log("found existing alert div");f=d.first()}if(c){if(e!=null){this.log("setting alert msg to",e);f.html(e)}f.show()}else{f.hide()}return this},callListener:function(d){d=d.toLowerCase();this.log("looking for listener "+d);var g=window[this.el.data(d)];if(g){this.log("calling listener "+d);var f=this.wizard;try{var c=g(this)}catch(h){this.log("exception calling listener "+d+": ",h)}}else{this.log("didn't find listener "+d)}},problem:function(c){this.nav.find("a").toggleClass("wizard-step-error",c)},validate:function(){var f=false;var e=this;this.el.find("[data-validate]").each(function(m,n){e.log("validating individiual inputs");n=b(n);var k=n.data("validate");if(!k){return}var l={status:true,title:"Error",msg:""};var j=window[k](n);b.extend(l,j);if(b("#btn-"+n.attr("id")).length===1){n=b("#btn-"+n.attr("id"))}if(!l.status){f=true;n.parents("div.form-group").toggleClass("has-error",true);if(b("#btn-"+n.attr("id")).length===1){n=b("#btn-"+n.attr("id"))}e.wizard.errorPopover(n,l.msg)}else{n.parents("div.form-group").toggleClass("has-error",false);if(b("#btn-"+n.attr("id")).length===1){n=b("#btn-"+n.attr("id"))}try{n.popover("destroy")}catch(o){n.popover("hide")}}});this.log("after validating inputs, failures is",f);var d=window[this.el.data("validate")];if(d){this.log("running html-embedded card validator");var g=d(this);if(typeof(g)=="undefined"||g==null){g=true}if(!g){f=true}this.log("after running html-embedded card validator, failures is",f)}this.log("running listener validator");var c=this.trigger("validate");if(typeof(c)=="undefined"||c==null){c=true}if(!c){f=true}this.log("after running listener validator, failures is",f);var h=!f;if(h){this.log("validated, calling listeners");this.trigger("validated")}else{this.log("invalid");this.trigger("invalid")}return h},log:function(){if(!window.console||!b.fn.wizard.logging){return}var c="card '"+this.name+"': ";var d=[c];d.push.apply(d,arguments);console.log.apply(console,d)},isActive:function(){return this.nav.hasClass("active")}};Wizard=function(c,d){this.wizard_template=['<div  class="modal fade wizard">','<div class="modal-dialog wizard-dialog">','<div class="modal-content wizard-content">','<div class="modal-header wizard-header">','<button type="button" class="close wizard-close" aria-hidden="true">&times;</button>','<h3 class="modal-title wizard-title"></h3>','<span class="wizard-subtitle"></span>',"</div>",'<div class="modal-body wizard-body">','<div class="pull-left wizard-steps">','<div class="wizard-nav-container">','<ul class="nav wizard-nav-list">',"</ul>","</div>",'<div class="wizard-progress-container">','<div class="progress progress-striped">','<div class="progress-bar" style="width: 0%;"></div>',"</div>","</div>","</div>","<form>",'<div class="wizard-cards">','<div class="wizard-card-container">',"</div>",'<div class="wizard-footer">','<div class="wizard-buttons-container">','<button class="btn wizard-cancel wizard-close" type="button">Cancel</button>','<div class="btn-group-single pull-right">','<button class="btn wizard-back" type="button">Back</button>','<button class="btn btn-primary wizard-next" type="button">Next</button>',"</div>","</div>","</div>","</div>","</form>","</div>","</div>","</div>","</div>"];this.args={keyboard:true,backdrop:true,show:false,submitUrl:"",showCancel:false,showClose:true,progressBarCurrent:false,increaseHeight:0,contentHeight:300,contentWidth:580,buttons:{cancelText:"Cancel",nextText:"Next",backText:"Back",submitText:"Submit",submittingText:"Submitting...",},formClass:"form-horizontal"};b.extend(this.args,d||{});this._create(c)};Wizard.prototype={log:function(){if(!window.console||!b.fn.wizard.logging){return}var c="wizard "+this.el.id+": ";var d=[c];d.push.apply(d,arguments);console.log.apply(console,d)},_create:function(d){this.markup=b(d);this.title=this.markup.data("title");this.submitCards=this.markup.find(".wizard-error,.wizard-failure,.wizard-success,.wizard-loading");this.el=b(this.wizard_template.join("\n"));b("body").append(this.el);this.modal=this.el.modal({keyboard:this.args.keyboard,show:this.args.show,backdrop:this.args.backdrop});this.dimensions={contentHeight:this.args.contentHeight,contentWidth:this.args.contentWidth};this.dialog=this.modal.find(".wizard-dialog");this.content=this.modal.find(".wizard-content");this.header=this.modal.find(".wizard-header");this.body=this.modal.find(".wizard-body");this.wizardSteps=this.modal.find(".wizard-steps");this.wizardCards=this.modal.find(".wizard-cards");this.wizardCardContainer=this.modal.find(".wizard-card-container");this.wizardCardContainer.append(this.markup.find(".wizard-card")).append(this.submitCards);this.navContainer=this.modal.find(".wizard-nav-container");this.navList=this.modal.find(".wizard-nav-list");this.progressContainer=this.modal.find(".wizard-progress-container");this.progress=this.progressContainer.find(".progress-bar");this.closeButton=this.modal.find("button.wizard-close.close");this.cardsContainer=this.modal.find("wizard-cards-container");this.form=this.modal.find("form");this.footer=this.modal.find(".wizard-footer");this.cancelButton=this.footer.find(".wizard-cancel");this.backButton=this.footer.find(".wizard-back");this.nextButton=this.footer.find(".wizard-next");this._cards=[];this.cards={};this._readyToSubmit=false;this.percentComplete=0;this._submitting=false;this._events={};this._firstShow=true;this._createCards();this.nextButton.click(this,this._handleNextClick);this.backButton.click(this,this._handleBackClick);this.cancelButton.text(this.args.buttons.cancelText);this.backButton.text(this.args.buttons.backText);this.nextButton.text(this.args.buttons.nextText);this.form.addClass(this.args.formClass);this.popovers=[];var c=this;var e=function(){c.reset();c.close();c.trigger("closed")};this.closeButton.click(e);this.cancelButton.click(e);this.wizardSteps.on("click","li.already-visited a.wizard-nav-link",this,function(g){var f=parseInt(b(g.target).data("navindex"));g.data.setCard(f)});this.on("submit",this._defaultSubmit);this.autoDimensions()},autoDimensions:function(){this.modal.css("display","block");this.dimensions.header=this.header.outerHeight(true);this.dimensions.navigation=this.wizardSteps.outerHeight(true);if(this.dimensions.navigation<this.dimensions.contentHeight){this.dimensions.navigation=this.dimensions.contentHeight}this.dimensions.body=this.dimensions.navigation;this.wizardSteps.height(this.dimensions.body);this.dimensions.modal=(this.dimensions.header+this.dimensions.navigation);this.content.height(this.dimensions.modal+"px");this.dialog.width(this.dimensions.contentWidth);this.body.height(this.dimensions.body+"px");this.wizardCards.height(this.dimensions.body+"px");this.dimensions.footer=this.footer.outerHeight(true);this.dimensions.cardContainer=(this.dimensions.body-this.dimensions.footer);this.wizardCardContainer.height(this.dimensions.cardContainer);this.dimensions.offset=(b(window).height()-this.dialog.height())/2;this.dialog.css({"margin-top":this.dimensions.offset+"px","padding-top":0});this.modal.css("display","")},setTitle:function(c){this.log("setting title to",c);this.modal.find(".wizard-title").first().text(c);return this},setSubtitle:function(c){this.log("setting subtitle to",c);this.modal.find(".wizard-subtitle").first().text(c);return this},errorPopover:function(d,f,c){this.log("launching popover on",d);c=typeof c!=="undefined"?c:false;var e=d.popover({content:f,trigger:"manual",html:c,container:d.parents(".form-group")}).addClass("error-popover").popover("show").next(".popover");d.parents(".form-group").find(".popover").addClass("error-popover");this.popovers.push(d);return e},destroyPopover:function(c){c=b(c);try{c.popover("destroy")}catch(d){c.popover("hide")}},hidePopovers:function(d){this.log("hiding all popovers");var c=this;b.each(this.popovers,function(e,f){c.destroyPopover(f)});this.modal.find(".has-error").removeClass("has-error");this.popovers=[]},eachCard:function(c){b.each(this._cards,c);return this},getActiveCard:function(){this.log("getting active card");var c=null;b.each(this._cards,function(e,d){if(d.isActive()){c=d;return false}});if(c){this.log("found active card",c)}else{this.log("couldn't find an active card")}return c},changeNextButton:function(d,c){this.log("changing next button, text: "+d,"class: "+c);if(typeof(c)!="undefined"){this.nextButton.removeClass("btn-success btn-primary")}if(c){this.nextButton.addClass(c)}this.nextButton.text(d);return this},hide:function(){this.log("hiding");this.modal.modal("hide");return this},close:function(){this.log("closing");this.modal.modal("hide");return this},show:function(c){this.log("showing");if(this._firstShow){this.setCard(0);this._firstShow=false}if(this.args.showCancel){this.cancelButton.show()}else{this.cancelButton.hide()}if(this.args.showClose){this.closeButton.show()}this.modal.modal("show");return this},on:function(c,d){this.log("adding listener to event "+c);this._events[c]=d;return this},trigger:function(){var f=arguments[0];var d=Array.prototype.slice.call(arguments);d.shift();d.unshift(this);this.log("firing event "+f);var g=this._events[f];if(g===undefined&&this.wizard!==undefined){g=this.wizard._events[f]}var c=null;if(typeof(g)=="function"){this.log("found event handler, calling "+f);try{c=g.apply(this,d)}catch(h){this.log("event handler "+f+" had an exception")}}else{this.log("couldn't find an event handler for "+f)}return c},reset:function(){this.log("resetting");this.updateProgressBar(0);this.hideSubmitCards();this.setCard(0);this.lockCards();this.enableNextButton();this.showButtons();this.hidePopovers();this.trigger("reset");return this},_abstractIncrementStep:function(e,f){var d=this.getActiveCard();var c;if(d){this.log("searching for valid next card");while(true){c=f(d);if(c){this.log("looking at card",c.index);if(c.isDisabled()){this.log("card "+c.index+" is disabled/locked, continuing");d=c;continue}else{return this.setCard(d.index+e)}}else{this.log("next card is not defined, breaking");break}}}else{this.log("current card is undefined")}},incrementCard:function(){this.log("incrementing card");var c=this._abstractIncrementStep(1,function(d){return d.next});this.trigger("incrementCard");return c},decrementCard:function(){this.log("decrementing card");var c=this._abstractIncrementStep(-1,function(d){return d.prev});this.trigger("decrementCard");return c},setCard:function(h){this.log("setting card to "+h);this.hideSubmitCards();var e=this.getActiveCard();if(this._submitting){this.log("we're submitting the wizard already, can't change cards");return e}var d=this._cards[h];if(d){if(d.isDisabled()){this.log("new card is currently disabled, returning");return e}if(e){if(h>e.index){var f=e;var g=false;while(f.index!=d.index){if(f.index!=e.index){f.prev.deselect();f.prev.markVisited();f.select()}g=f.validate();if(!g){return f}f=f.next}f.prev.deselect();f.prev.markVisited()}e.deselect();e.markVisited()}d.select();if(this.args.progressBarCurrent){this.percentComplete=h*100/this._cards.length;this.updateProgressBar(this.percentComplete)}else{var c=this.percentComplete;this.percentComplete=h*100/this._cards.length;this.percentComplete=Math.max(c,this.percentComplete);this.updateProgressBar(this.percentComplete)}return d}else{this.log("couldn't find card "+h)}},updateProgressBar:function(c){this.log("updating progress to "+c+"%");this.progress.css({width:c+"%"});this.percentComplete=c;this.trigger("progressBar",c);if(c==100){this.log("progress is 100, animating progress bar");this.progressContainer.find(".progress").addClass("active")}else{if(c==0){this.log("progress is 0, disabling animation");this.progressContainer.find(".progress").removeClass("active")}}},getNextCard:function(){var c=this.getActiveCard();if(c){return c.next}},lockCards:function(){this.log("locking nav cards");this.eachCard(function(d,c){c.unmarkVisited()});return this},disableCards:function(){this.log("disabling all nav cards");this.eachCard(function(d,c){c.disable()});return this},enableCards:function(){this.log("enabling all nav cards");this.eachCard(function(d,c){c.enable()});return this},hideCards:function(){this.log("hiding cards");this.eachCard(function(d,c){c.deselect()});this.hideSubmitCards();return this},hideButtons:function(){this.log("hiding buttons");this.cancelButton.hide();this.closeButton.hide();this.nextButton.hide();this.backButton.hide();return this},showButtons:function(){this.log("showing buttons");if(this.args.showCancel){this.cancelButton.show()}else{this.cancelButton.hide()}if(this.args.showClose){this.closeButton.show()}this.nextButton.show();this.backButton.show();return this},getCard:function(d){var c=b(d).parents(".wizard-card").first()[0];if(c){var e=null;this.eachCard(function(g,f){if(c==f.el[0]){e=f;return false}return true});return e}else{return null}},_createCards:function(){var f=null;var e=null;var c=null;var g=this;var d=this;d.log("Creating Cards");var h=this.modal.find(".wizard-cards .wizard-card");b.each(h,function(k,j){j=b(j);f=c;c=new a(g,j,k,f,e);d._cards.push(c);if(c.name){d.cards[c.name]=c}if(f){f.next=c}d.modal.find(".wizard-steps .wizard-nav-list").append(c.nav)})},showSubmitCard:function(d){this.log("showing "+d+" submit card");var c=this.el.find(".wizard-"+d);if(c.length){this.hideCards();this.el.find(".wizard-"+d).show()}else{this.log("couldn't find submit card "+d)}},hideSubmitCard:function(c){this.log("hiding "+c+" submit card");this.el.find(".wizard-"+c).hide()},hideSubmitCards:function(){var c=this;b.each(["success","error","failure","loading"],function(e,d){c.hideSubmitCard(d)})},enableNextButton:function(){this.log("enabling next button");this.nextButton.removeAttr("disabled");return this},disableNextButton:function(){this.log("disabling next button");this.nextButton.attr("disabled","disabled");return this},serializeArray:function(){var c=this.form.serializeArray();this.form.find('input[disabled][data-serialize="1"]').each(function(){formObj={name:b(this).attr("name"),value:b(this).val()};c.push(formObj)});return c},serialize:function(){var c=this.form.serialize();this.form.find('input[disabled][data-serialize="1"]').each(function(){c=c+"&"+b(this).attr("name")+"="+b(this).val()});return c},find:function(c){return this.modal.find(c)},submitSuccess:function(){this.log("submit success");this._submitting=false;this.showSubmitCard("success");this.trigger("submitSuccess")},submitFailure:function(){this.log("submit failure");this._submitting=false;this.showSubmitCard("failure");this.trigger("submitFailure")},submitError:function(){this.log("submit error");this._submitting=false;this.showSubmitCard("error");this.trigger("submitError")},_submit:function(){this.log("submitting wizard");this._submitting=true;this.lockCards();this.cancelButton.hide();this.closeButton.hide();this.backButton.hide();this.showSubmitCard("loading");this.updateProgressBar(100);this.changeNextButton(this.args.buttons.submittingText,false);this.disableNextButton();var c=this.trigger("submit");this.trigger("loading")},_onNextClick:function(){this.log("handling 'next' button click");var c=this.getActiveCard();if(this._readyToSubmit&&c.validate()){this._submit()}else{c=this.incrementCard()}},_onBackClick:function(){this.log("handling 'back' button click");var c=this.decrementCard()},_handleNextClick:function(c){var d=c.data;d._onNextClick.call(d)},_handleBackClick:function(c){var d=c.data;d._onBackClick.call(d)},_defaultSubmit:function(c){b.ajax({type:"POST",url:c.args.submitUrl,data:c.serialize(),dataType:"json"}).done(function(d){c.submitSuccess();c.hideButtons();c.updateProgressBar(0)}).fail(function(){c.submitFailure();c.hideButtons()})}}}(window.jQuery));