(function(b){b.fn.wizard=function(c){return new Wizard(this,c)};b.fn.wizard.logging=false;var a=function(g,d,h,f,c){this.wizard=g;this.index=h;this.prev=f;this.next=c;this.el=d;this.title=d.find("h3").first().text();this.name=d.data("cardname")||this.title;this.nav=this._createNavElement(this.title,h);this._disabled=false;this._loaded=false;this._events={}};a.prototype={select:function(){this.log("selecting");if(!this.isSelected()){this.nav.addClass("active");this.el.show();if(!this._loaded){this.trigger("loaded");this.reload()}this.trigger("selected")}var c=this.wizard;c.backButton.toggleClass("disabled",this.index==0);if(this.index>=c._cards.length-1){this.log("on last card, changing next button to submit");c.changeNextButton(c.args.buttons.submitText,"btn-success");c._readyToSubmit=true;c.trigger("readySubmit")}else{c._readyToSubmit=false;c.changeNextButton(c.args.buttons.nextText,"btn-primary")}return this},_createNavElement:function(d,f){var e=b('<li class="wizard-nav-item"></li>');var c=b('<a class="wizard-nav-link"></a>');c.data("navindex",f);e.append(c);c.append('<span class="glyphicon glyphicon-chevron-right"></span> ');c.append(d);return e},markVisited:function(){this.log("marking as visited");this.nav.addClass("already-visited");this.trigger("markVisited");return this},unmarkVisited:function(){this.log("unmarking as visited");this.nav.removeClass("already-visited");this.trigger("unmarkVisited");return this},deselect:function(){this.nav.removeClass("active");this.el.hide();this.trigger("deselect");return this},enable:function(){this.log("enabling");this.nav.addClass("active");this._disabled=false;this.trigger("enabled");return this},disable:function(c){this.log("disabling");this._disabled=true;this.nav.removeClass("active already-visited");if(c){this.el.hide()}this.trigger("disabled");return this},isDisabled:function(){return this._disabled},alreadyVisited:function(){return this.nav.hasClass("already-visited")},isSelected:function(){return this.nav.hasClass("active")},reload:function(){this._loaded=true;this.trigger("reload");return this},on:function(){return this.wizard.on.apply(this,arguments)},trigger:function(){this.callListener("on"+arguments[0]);return this.wizard.trigger.apply(this,arguments)},toggleAlert:function(d,f){this.log("toggling alert to: "+f);f=typeof f=="undefined"?true:f;if(f){this.trigger("showAlert")}else{this.trigger("hideAlert")}var e;var c=this.el.children("h3").first().next("div.alert");if(c.length==0){if(!f){return this}this.log("couldn't find existing alert div, creating one");e=b("<div />");e.addClass("alert");e.addClass("hide");e.insertAfter(this.el.find("h3").first())}else{this.log("found existing alert div");e=c.first()}if(f){if(d!=null){this.log("setting alert msg to",d);e.html(d)}e.show()}else{e.hide()}return this},callListener:function(g){g=g.toLowerCase();this.log("looking for listener "+g);var d=window[this.el.data(g)];if(d){this.log("calling listener "+g);var h=this.wizard;try{var f=d(this)}catch(c){this.log("exception calling listener "+g+": ",c)}}else{this.log("didn't find listener "+g)}},problem:function(c){this.nav.find("a").toggleClass("wizard-step-error",c)},validate:function(){var d=false;var h=this;this.el.find("[data-validate]").each(function(n,l){h.log("validating individiual inputs");l=b(l);var m=l.data("validate");if(!m){return}var p={status:true,title:"Error",msg:""};var k=window[m](l);b.extend(p,k);if(b("#btn-"+l.attr("id")).length===1){l=b("#btn-"+l.attr("id"))}if(!p.status){d=true;l.parents("div.form-group").toggleClass("has-error",true);if(b("#btn-"+l.attr("id")).length===1){l=b("#btn-"+l.attr("id"))}h.wizard.errorPopover(l,p.msg)}else{l.parents("div.form-group").toggleClass("has-error",false);if(b("#btn-"+l.attr("id")).length===1){l=b("#btn-"+l.attr("id"))}try{l.popover("destroy")}catch(j){l.popover("hide")}}});this.log("after validating inputs, failures is",d);var f=window[this.el.data("validate")];if(f){this.log("running html-embedded card validator");var c=f(this);if(typeof c=="undefined"||c==null){c=true}if(!c){d=true}this.log("after running html-embedded card validator, failures is",d)}this.log("running listener validator");var e=this.trigger("validate");if(typeof e=="undefined"||e==null){e=true}if(!e){d=true}this.log("after running listener validator, failures is",d);var g=!d;if(g){this.log("validated, calling listeners");this.trigger("validated")}else{this.log("invalid");this.trigger("invalid")}return g},log:function(){if(!window.console||!b.fn.wizard.logging){return}var c="card '"+this.name+"': ";var d=[c];d.push.apply(d,arguments);console.log.apply(console,d)},isActive:function(){return this.nav.hasClass("active")}};Wizard=function(c,d){this.wizard_template=['<div  class="modal fade wizard">','<div class="modal-dialog wizard-dialog">','<div class="modal-content wizard-content">','<div class="modal-header wizard-header">','<button type="button" class="close wizard-close" aria-hidden="true">&times;</button>','<h3 class="modal-title wizard-title"></h3>','<span class="wizard-subtitle"></span>',"</div>",'<div class="modal-body wizard-body">','<div class="pull-left wizard-steps">','<div class="wizard-nav-container">','<ul class="nav wizard-nav-list">',"</ul>","</div>",'<div class="wizard-progress-container">','<div class="progress progress-striped">','<div class="progress-bar" style="width: 0%;"></div>',"</div>","</div>","</div>","<form>",'<div class="wizard-cards">','<div class="wizard-card-container">',"</div>",'<div class="wizard-footer">','<div class="wizard-buttons-container">','<button class="btn wizard-cancel wizard-close" type="button">Cancel</button>','<div class="btn-group-single pull-right">','<button class="btn wizard-back" type="button">Back</button>','<button class="btn btn-primary wizard-next" type="button">Next</button>',"</div>","</div>","</div>","</div>","</form>","</div>","</div>","</div>","</div>"];this.args={keyboard:true,backdrop:true,show:false,submitUrl:"",showCancel:false,showClose:true,progressBarCurrent:false,increaseHeight:0,contentHeight:300,contentWidth:580,buttons:{cancelText:"Cancel",nextText:"Next",backText:"Back",submitText:"Submit",submittingText:"Submitting..."},formClass:"form-horizontal"};b.extend(this.args,d||{});this._create(c)};Wizard.prototype={log:function(){if(!window.console||!b.fn.wizard.logging){return}var c="wizard "+this.el.id+": ";var d=[c];d.push.apply(d,arguments);console.log.apply(console,d)},_create:function(c){this.markup=b(c);this.title=this.markup.data("title");this.submitCards=this.markup.find(".wizard-error,.wizard-failure,.wizard-success,.wizard-loading");this.el=b(this.wizard_template.join("\n"));b("body").append(this.el);this.modal=this.el.modal({keyboard:this.args.keyboard,show:this.args.show,backdrop:this.args.backdrop});this.dimensions={contentHeight:this.args.contentHeight,contentWidth:this.args.contentWidth};this.dialog=this.modal.find(".wizard-dialog");this.content=this.modal.find(".wizard-content");this.header=this.modal.find(".wizard-header");this.body=this.modal.find(".wizard-body");this.wizardSteps=this.modal.find(".wizard-steps");this.wizardCards=this.modal.find(".wizard-cards");this.wizardCardContainer=this.modal.find(".wizard-card-container");this.wizardCardContainer.append(this.markup.find(".wizard-card")).append(this.submitCards);this.navContainer=this.modal.find(".wizard-nav-container");this.navList=this.modal.find(".wizard-nav-list");this.progressContainer=this.modal.find(".wizard-progress-container");this.progress=this.progressContainer.find(".progress-bar");this.closeButton=this.modal.find("button.wizard-close.close");this.cardsContainer=this.modal.find("wizard-cards-container");this.form=this.modal.find("form");this.footer=this.modal.find(".wizard-footer");this.cancelButton=this.footer.find(".wizard-cancel");this.backButton=this.footer.find(".wizard-back");this.nextButton=this.footer.find(".wizard-next");this._cards=[];this.cards={};this._readyToSubmit=false;this.percentComplete=0;this._submitting=false;this._events={};this._firstShow=true;this._createCards();this.nextButton.click(this,this._handleNextClick);this.backButton.click(this,this._handleBackClick);this.cancelButton.text(this.args.buttons.cancelText);this.backButton.text(this.args.buttons.backText);this.nextButton.text(this.args.buttons.nextText);this.form.addClass(this.args.formClass);this.popovers=[];var e=this;var d=function(){e.reset();e.close();e.trigger("closed")};this.closeButton.click(d);this.cancelButton.click(d);this.wizardSteps.on("click","li.already-visited a.wizard-nav-link",this,function(f){var g=parseInt(b(f.target).data("navindex"));f.data.setCard(g)});if(this.title.length!=0){this.setTitle(this.title)}this.on("submit",this._defaultSubmit);this.autoDimensions()},autoDimensions:function(){this.modal.css("display","block");this.dimensions.header=this.header.outerHeight(true);this.dimensions.navigation=this.wizardSteps.outerHeight(true);if(this.dimensions.navigation<this.dimensions.contentHeight){this.dimensions.navigation=this.dimensions.contentHeight;this.navContainer.height(this.dimensions.contentHeight-30-this.progressContainer.outerHeight(true))}this.dimensions.body=this.dimensions.navigation;this.wizardSteps.height(this.dimensions.body);this.dimensions.modal=this.dimensions.header+this.dimensions.navigation;this.content.height(this.dimensions.modal+"px");this.dialog.width(this.dimensions.contentWidth);this.body.height(this.dimensions.body+"px");this.wizardCards.height(this.dimensions.body+"px");this.dimensions.footer=this.footer.outerHeight(true);this.dimensions.cardContainer=this.dimensions.body-this.dimensions.footer;this.wizardCardContainer.height(this.dimensions.cardContainer);this.dimensions.offset=(b(window).height()-this.dialog.height())/2;this.dialog.css({"margin-top":this.dimensions.offset+"px","padding-top":0});this.modal.css("display","")},setTitle:function(c){this.log("setting title to",c);this.modal.find(".wizard-title").first().text(c);return this},setSubtitle:function(c){this.log("setting subtitle to",c);this.modal.find(".wizard-subtitle").first().text(c);return this},errorPopover:function(f,c,g){this.log("launching popover on",f);g=typeof g!=="undefined"?g:false;var d=f.popover({content:c,trigger:"manual",html:g,container:f.parents(".form-group")}).addClass("error-popover").popover("show").next(".popover");f.parents(".form-group").find(".popover").addClass("error-popover");this.popovers.push(f);return d},destroyPopover:function(c){c=b(c);try{c.popover("destroy")}catch(d){c.popover("hide")}},hidePopovers:function(c){this.log("hiding all popovers");var d=this;b.each(this.popovers,function(g,f){d.destroyPopover(f)});this.modal.find(".has-error").removeClass("has-error");this.popovers=[]},eachCard:function(c){b.each(this._cards,c);return this},getActiveCard:function(){this.log("getting active card");var c=null;b.each(this._cards,function(d,f){if(f.isActive()){c=f;return false}});if(c){this.log("found active card",c)}else{this.log("couldn't find an active card")}return c},changeNextButton:function(d,c){this.log("changing next button, text: "+d,"class: "+c);if(typeof c!="undefined"){this.nextButton.removeClass("btn-success btn-primary")}if(c){this.nextButton.addClass(c)}this.nextButton.text(d);return this},hide:function(){this.log("hiding");this.modal.modal("hide");return this},close:function(){this.log("closing");this.modal.modal("hide");return this},show:function(c){this.log("showing");if(this._firstShow){this.setCard(0);this._firstShow=false}if(this.args.showCancel){this.cancelButton.show()}else{this.cancelButton.hide()}if(this.args.showClose){this.closeButton.show()}this.modal.modal("show");return this},on:function(d,c){this.log("adding listener to event "+d);this._events[d]=c;return this},trigger:function(){var g=arguments[0];var d=Array.prototype.slice.call(arguments);d.shift();d.unshift(this);this.log("firing event "+g);var h=this._events[g];if(h===undefined&&this.wizard!==undefined){h=this.wizard._events[g]}var f=null;if(typeof h=="function"){this.log("found event handler, calling "+g);try{f=h.apply(this,d)}catch(c){this.log("event handler "+g+" had an exception")}}else{this.log("couldn't find an event handler for "+g)}return f},reset:function(){this.log("resetting");this.updateProgressBar(0);this.hideSubmitCards();this.setCard(0);this.lockCards();this.enableNextButton();this.showButtons();this.hidePopovers();this.trigger("reset");return this},_abstractIncrementStep:function(f,c){var g=this.getActiveCard();var d;if(g){this.log("searching for valid next card");while(true){d=c(g);if(d){this.log("looking at card",d.index);if(d.isDisabled()){this.log("card "+d.index+" is disabled/locked, continuing");g=d;continue}else{return this.setCard(g.index+f)}}else{this.log("next card is not defined, breaking");break}}}else{this.log("current card is undefined")}},incrementCard:function(){this.log("incrementing card");var c=this._abstractIncrementStep(1,function(d){return d.next});this.trigger("incrementCard");return c},decrementCard:function(){this.log("decrementing card");var c=this._abstractIncrementStep(-1,function(d){return d.prev});this.trigger("decrementCard");return c},setCard:function(h){this.log("setting card to "+h);this.hideSubmitCards();var d=this.getActiveCard();if(this._submitting){this.log("we're submitting the wizard already, can't change cards");return d}var j=this._cards[h];if(j){if(j.isDisabled()){this.log("new card is currently disabled, returning");return d}if(d){if(h>d.index){var g=d;var c=false;while(g.index!=j.index){if(g.index!=d.index){g.prev.deselect();g.prev.markVisited();g.select()}c=g.validate();if(!c){return g}g=g.next}g.prev.deselect();g.prev.markVisited()}d.deselect();d.markVisited()}j.select();if(this.args.progressBarCurrent){this.percentComplete=h*100/this._cards.length;this.updateProgressBar(this.percentComplete)}else{var f=this.percentComplete;this.percentComplete=h*100/this._cards.length;this.percentComplete=Math.max(f,this.percentComplete);this.updateProgressBar(this.percentComplete)}return j}else{this.log("couldn't find card "+h)}},updateProgressBar:function(c){this.log("updating progress to "+c+"%");this.progress.css({width:c+"%"});this.percentComplete=c;this.trigger("progressBar",c);if(c==100){this.log("progress is 100, animating progress bar");this.progressContainer.find(".progress").addClass("active")}else{if(c==0){this.log("progress is 0, disabling animation");this.progressContainer.find(".progress").removeClass("active")}}},getNextCard:function(){var c=this.getActiveCard();if(c){return c.next}},lockCards:function(){this.log("locking nav cards");this.eachCard(function(d,c){c.unmarkVisited()});return this},disableCards:function(){this.log("disabling all nav cards");this.eachCard(function(d,c){c.disable()});return this},enableCards:function(){this.log("enabling all nav cards");this.eachCard(function(d,c){c.enable()});return this},hideCards:function(){this.log("hiding cards");this.eachCard(function(d,c){c.deselect()});this.hideSubmitCards();return this},hideButtons:function(){this.log("hiding buttons");this.cancelButton.hide();this.closeButton.hide();this.nextButton.hide();this.backButton.hide();return this},showButtons:function(){this.log("showing buttons");if(this.args.showCancel){this.cancelButton.show()}else{this.cancelButton.hide()}if(this.args.showClose){this.closeButton.show()}this.nextButton.show();this.backButton.show();return this},getCard:function(c){var e=b(c).parents(".wizard-card").first()[0];if(e){var d=null;this.eachCard(function(g,f){if(e==f.el[0]){d=f;return false}return true});return d}else{return null}},_createCards:function(){var h=null;var f=null;var d=null;var e=this;var g=this;g.log("Creating Cards");var c=this.modal.find(".wizard-cards .wizard-card");b.each(c,function(j,i){i=b(i);h=d;d=new a(e,i,j,h,f);g._cards.push(d);if(d.name){g.cards[d.name]=d}if(h){h.next=d}g.modal.find(".wizard-steps .wizard-nav-list").append(d.nav)})},showSubmitCard:function(d){this.log("showing "+d+" submit card");var c=this.el.find(".wizard-"+d);if(c.length){this.hideCards();this.el.find(".wizard-"+d).show()}else{this.log("couldn't find submit card "+d)}},hideSubmitCard:function(c){this.log("hiding "+c+" submit card");this.el.find(".wizard-"+c).hide()},hideSubmitCards:function(){var c=this;b.each(["success","error","failure","loading"],function(d,f){c.hideSubmitCard(f)})},enableNextButton:function(){this.log("enabling next button");this.nextButton.removeAttr("disabled");return this},disableNextButton:function(){this.log("disabling next button");this.nextButton.attr("disabled","disabled");return this},serializeArray:function(){var c=this.form.serializeArray();this.form.find('input[disabled][data-serialize="1"]').each(function(){formObj={name:b(this).attr("name"),value:b(this).val()};c.push(formObj)});return c},serialize:function(){var c=this.form.serialize();this.form.find('input[disabled][data-serialize="1"]').each(function(){c=c+"&"+b(this).attr("name")+"="+b(this).val()});return c},find:function(c){return this.modal.find(c)},submitSuccess:function(){this.log("submit success");this._submitting=false;this.showSubmitCard("success");this.trigger("submitSuccess")},submitFailure:function(){this.log("submit failure");this._submitting=false;this.showSubmitCard("failure");this.trigger("submitFailure")},submitError:function(){this.log("submit error");this._submitting=false;this.showSubmitCard("error");this.trigger("submitError")},_submit:function(){this.log("submitting wizard");this._submitting=true;this.lockCards();this.cancelButton.hide();this.closeButton.hide();this.backButton.hide();this.showSubmitCard("loading");this.updateProgressBar(100);this.changeNextButton(this.args.buttons.submittingText,false);this.disableNextButton();var c=this.trigger("submit");this.trigger("loading")},_onNextClick:function(){this.log("handling 'next' button click");var c=this.getActiveCard();if(this._readyToSubmit&&c.validate()){this._submit()}else{c=this.incrementCard()}},_onBackClick:function(){this.log("handling 'back' button click");var c=this.decrementCard()},_handleNextClick:function(d){var c=d.data;c._onNextClick.call(c)},_handleBackClick:function(d){var c=d.data;c._onBackClick.call(c)},_defaultSubmit:function(c){b.ajax({type:"POST",url:c.args.submitUrl,data:c.serialize(),dataType:"json"}).done(function(d){c.submitSuccess();c.hideButtons();c.updateProgressBar(0)}).fail(function(){c.submitFailure();c.hideButtons()})}}})(window.jQuery);