tinymce.PluginManager.add("autosave",function(x){function C(c,a){var d={s:1000,m:60000};return c=/^(\d+)([ms]?)$/.exec(""+(c||a)),(c[2]?d[c[2]]:1)*parseInt(c,10)}function j(){var a=parseInt(w.getItem(v+"autosave.time"),10)||0;return(new Date).getTime()-a>y.autosave_retention?(q(!1),!1):!0}function q(a){w.removeItem(v+"autosave.draft"),w.removeItem(v+"autosave.time"),a!==!1&&x.fire("RemoveDraft")}function A(){z()||(w.setItem(v+"autosave.draft",x.getContent({format:"raw",no_events:!0})),w.setItem(v+"autosave.time",(new Date).getTime()),x.fire("StoreDraft"))}function b(){j()&&(x.setContent(w.getItem(v+"autosave.draft"),{format:"raw"}),x.fire("RestoreDraft"))}function g(){k||(setInterval(function(){x.removed||A()},y.autosave_interval),k=!0)}function D(){var a=this;a.disabled(!j()),x.on("StoreDraft RestoreDraft RemoveDraft",function(){a.disabled(!j())}),g()}function p(){x.undoManager.beforeChange(),b(),q(),x.undoManager.add()}function B(){var a;return tinymce.each(tinymce.editors,function(c){c.plugins.autosave&&c.plugins.autosave.storeDraft(),!a&&c.isDirty()&&c.getParam("autosave_ask_before_unload",!0)&&(a=c.translate("You have unsaved changes are you sure you want to navigate away?"))}),a}function z(a){var c=x.settings.forced_root_block;return a=tinymce.trim("undefined"==typeof a?x.getBody().innerHTML:a),""===a||new RegExp("^<"+c+">((Â |&nbsp;|[ 	]|<br[^>]*>)+?|)</"+c+">|<br>$","i").test(a)}var k,y=x.settings,w=tinymce.util.LocalStorage,v=x.id;y.autosave_interval=C(y.autosave_interval,"30s"),y.autosave_retention=C(y.autosave_retention,"20m"),x.addButton("restoredraft",{title:"Restore last draft",onclick:p,onPostRender:D}),x.addMenuItem("restoredraft",{text:"Restore last draft",onclick:p,onPostRender:D,context:"file"}),x.settings.autosave_restore_when_empty!==!1&&(x.on("init",function(){j()&&z()&&b()}),x.on("saveContent",function(){q()})),window.onbeforeunload=B,this.hasDraft=j,this.storeDraft=A,this.restoreDraft=b,this.removeDraft=q,this.isEmpty=z});