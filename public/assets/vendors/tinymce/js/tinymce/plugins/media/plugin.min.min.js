tinymce.PluginManager.add("media",function(j,p){function f(a){return -1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function h(){function o(n){var i,l,c,u;i=s.find("#width")[0],l=s.find("#height")[0],c=i.value(),u=l.value(),s.find("#constrain")[0].checked()&&e&&r&&c&&u&&(n.control==i?(u=Math.round(c/e*u),l.value(u)):(c=Math.round(u/r*c),i.value(c))),e=c,r=u}var s,e,r,a;a=q(j.selection.getNode()),e=a.width,r=a.height,s=j.windowManager.open({title:"Insert/edit video",data:a,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){this.fromJSON(d(this.next().find("#embed").value()))},items:[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source"},{name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"},{name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:o},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:o},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}]},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(m(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:"},{type:"textbox",flex:1,name:"embed",value:b(),multiline:!0,label:"Source"}]}],onSubmit:function(){j.insertContent(m(this.toJSON()))}})}function b(){var a=j.selection.getNode();return a.getAttribute("data-mce-object")?j.selection.getContent():void 0}function m(a){var c="";return a.source1||(tinymce.extend(a,d(a.embed)),a.source1)?(a.source1=j.convertURL(a.source1,"source"),a.source2=j.convertURL(a.source2,"source"),a.source1mime=f(a.source1),a.source2mime=f(a.source2),a.poster=j.convertURL(a.poster,"poster"),a.flashPlayerUrl=j.convertURL(p+"/moxieplayer.swf","movie"),a.embed?c=k(a.embed,a,!0):(tinymce.each(g,function(o){var i,s,l;if(i=o.regex.exec(a.source1)){for(l=o.url,s=0;i[s];s++){l=l.replace("$"+s,function(){return i[s]})}a.source1=l,a.type=o.type,a.width=o.w,a.height=o.h}}),a.width=a.width||300,a.height=a.height||150,tinymce.each(a,function(e,i){a[i]=j.dom.encode(e)}),"iframe"==a.type?c+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"></iframe>':"application/x-shockwave-flash"==a.source1mime?(c+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&(c+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),c+="</object>"):-1!=a.source1mime.indexOf("audio")?j.settings.audio_template_callback?c=j.settings.audio_template_callback(a):c+='<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>":c=j.settings.video_template_callback?j.settings.video_template_callback(a):'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"),c):""}function d(c){var a={};return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",start:function(i,l){a.source1||"param"!=i||(a.source1=l.map.movie),("iframe"==i||"object"==i||"embed"==i||"video"==i||"audio"==i)&&(a=tinymce.extend(l.map,a)),"source"==i&&(a.source1?a.source2||(a.source2=l.map.src):a.source1=l.map.src),"img"!=i||a.poster||(a.poster=l.map.src)}}).parse(c),a.source1=a.source1||a.src||a.data,a.source2=a.source2||"",a.poster=a.poster||"",a}function q(a){return a.getAttribute("data-mce-object")?d(j.serializer.serialize(a,{selection:!0})):{}}function k(v,s,x){function l(B,z){var C,y,A,o;for(C in z){if(A=""+z[C],B.map[C]){for(y=B.length;y--;){o=B[y],o.name==C&&(A?(B.map[C]=A,o.value=A):(delete B.map[C],B.splice(y,1)))}}else{A&&(B.push({name:C,value:A}),B.map[C]=A)}}}var u,c=new tinymce.html.Writer,w=0;return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",comment:function(a){c.comment(a)},cdata:function(a){c.cdata(a)},text:function(i,a){c.text(i,a)},start:function(i,a,n){switch(i){case"video":case"object":case"img":case"iframe":l(a,{width:s.width,height:s.height})}if(x){switch(i){case"video":l(a,{poster:s.poster,src:""}),s.source2&&l(a,{src:""});break;case"iframe":l(a,{src:s.source1});break;case"source":if(w++,2>=w&&(l(a,{src:s["source"+w],type:s["source"+w+"mime"]}),!s["source"+w])){return}break;case"img":if(!s.poster){return}u=!0}}c.start(i,a,n)},end:function(n){if("video"==n&&x){for(var i=1;2>=i;i++){if(s["source"+i]){var o=[];o.map={},i>w&&(l(o,{src:s["source"+i],type:s["source"+i+"mime"]}),c.start("source",o,!0))}}}if(s.poster&&"object"==n&&x&&!u){var a=[];a.map={},l(a,{src:s.poster,width:s.width,height:s.height}),c.start("img",a,!0)}c.end(n)}},new tinymce.html.Schema({})).parse(v),c.getContent()}var g=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];j.on("ResolveName",function(c){var a;1==c.target.nodeType&&(a=c.target.getAttribute("data-mce-object"))&&(c.name=a)}),j.on("preInit",function(){var a=j.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(i){a[i]=new RegExp("</"+i+"[^>]*>","gi")}),j.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var c=j.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(i){c[i]={}}),j.parser.addNodeFilter("iframe,video,audio,object,embed",function(B,v){for(var x,e,A,u,C,z,w,y=B.length;y--;){for(e=B[y],A=new tinymce.html.Node("img",1),A.shortEnded=!0,z=e.attributes,x=z.length;x--;){u=z[x].name,C=z[x].value,"width"!==u&&"height"!==u&&"style"!==u&&(("data"==u||"src"==u)&&(C=j.convertURL(C,u)),A.attr("data-mce-p-"+u,C))}w=e.firstChild&&e.firstChild.value,w&&(A.attr("data-mce-html",escape(w)),A.firstChild=null),A.attr({width:e.attr("width")||"300",height:e.attr("height")||("audio"==v?"30":"150"),style:e.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":v,"class":"mce-object mce-object-"+v}),e.replace(A)}}),j.serializer.addAttributeFilter("data-mce-object",function(z,C){for(var w,y,u,B,v,D,A=z.length;A--;){for(w=z[A],y=new tinymce.html.Node(w.attr(C),1),"audio"!=w.attr(C)&&y.attr({width:w.attr("width"),height:w.attr("height")}),y.attr({style:w.attr("style")}),B=w.attributes,u=B.length;u--;){var x=B[u].name;0===x.indexOf("data-mce-p-")&&y.attr(x.substr(11),B[u].value)}v=w.attr("data-mce-html"),v&&(D=new tinymce.html.Node("#text",3),D.raw=!0,D.value=unescape(v),y.append(D)),w.replace(y)}})}),j.on("ObjectSelected",function(a){"audio"==a.target.getAttribute("data-mce-object")&&a.preventDefault()}),j.on("objectResized",function(c){var a,i=c.target;i.getAttribute("data-mce-object")&&(a=i.getAttribute("data-mce-html"),a&&(a=unescape(a),i.setAttribute("data-mce-html",escape(k(a,{width:c.width,height:c.height})))))}),j.addButton("media",{tooltip:"Insert/edit video",onclick:h,stateSelector:"img[data-mce-object=video]"}),j.addMenuItem("media",{icon:"media",text:"Insert video",onclick:h,context:"insert",prependToContext:!0})});