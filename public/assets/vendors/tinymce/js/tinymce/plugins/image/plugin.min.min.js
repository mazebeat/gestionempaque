tinymce.PluginManager.add("image",function(c){function b(j,h){function k(i,l){g.parentNode.removeChild(g),h({width:i,height:l})}var g=document.createElement("img");g.onload=function(){k(g.clientWidth,g.clientHeight)},g.onerror=function(){k()},g.src=j;var f=g.style;f.visibility="hidden",f.position="fixed",f.bottom=f.left=0,f.width=f.height="auto",document.body.appendChild(g)}function d(e){return function(){var f=c.settings.image_list;"string"==typeof f?tinymce.util.XHR.send({url:f,success:function(g){e(tinymce.util.JSON.parse(g))}}):e(f)}}function a(q){function w(){var f=[{text:"None",value:""}];return tinymce.each(q,function(g){f.push({text:g.text||g.title,value:g.value||g.url,menu:g.menu})}),f}function C(l){var h,m,g,f;h=B.find("#width")[0],m=B.find("#height")[0],g=h.value(),f=m.value(),B.find("#constrain")[0].checked()&&A&&t&&g&&f&&(l.control==h?(f=Math.round(g/A*f),m.value(f)):(g=Math.round(f/t*g),h.value(g))),A=g,t=f}function k(){function f(l){function h(){l.onload=l.onerror=null,c.selection.select(l),c.nodeChanged()}l.onload=function(){g.width||g.height||x.setAttribs(l,{width:l.clientWidth,height:l.clientHeight}),h()},l.onerror=h}var g=B.toJSON();""===g.width&&(g.width=null),""===g.height&&(g.height=null),""===g.style&&(g.style=null),g={src:g.src,alt:g.alt,width:g.width,height:g.height,style:g.style},c.undoManager.transact(function(){return g.src?(y?x.setAttribs(y,g):(g.id="__mcenew",c.selection.setContent(x.createHTML("img",g)),y=x.get("__mcenew"),x.setAttrib(y,"id",null)),f(y),void 0):(y&&(x.remove(y),c.nodeChanged()),void 0)})}function e(f){return f&&(f=f.replace(/px$/,"")),f}function E(){b(this.value(),function(f){f.width&&f.height&&(A=f.width,t=f.height,B.find("#width").value(A),B.find("#height").value(t))})}function v(){function g(i){return i.length>0&&/^[0-9]+$/.test(i)&&(i+="px"),i}var f=B.toJSON(),h=x.parseStyle(f.style);x.setAttrib(y,"style",""),delete h.margin,h["margin-top"]=h["margin-bottom"]=g(f.vspace),h["margin-left"]=h["margin-right"]=g(f.hspace),h["border-width"]=g(f.border),B.find("#style").value(x.serializeStyle(x.parseStyle(x.serializeStyle(h))))}var B,D,A,t,z,x=c.dom,y=c.selection.getNode();A=x.getAttrib(y,"width"),t=x.getAttrib(y,"height"),"IMG"!=y.nodeName||y.getAttribute("data-mce-object")?y=null:D={src:x.getAttrib(y,"src"),alt:x.getAttrib(y,"alt"),width:A,height:t},q&&(z={name:"target",type:"listbox",label:"Image list",values:w(),onselect:function(g){var f=B.find("#alt");(!f.value()||g.lastControl&&f.value()==g.lastControl.text())&&f.value(g.control.text()),B.find("#src").value(g.control.value())}});var j=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:E},z,{name:"alt",type:"textbox",label:"Image description"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:C},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:C},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}];c.settings.image_advtab?(y&&(D.hspace=e(y.style.marginLeft||y.style.marginRight),D.vspace=e(y.style.marginTop||y.style.marginBottom),D.border=e(y.style.borderWidth),D.style=c.dom.serializeStyle(c.dom.parseStyle(c.dom.getAttrib(y,"style")))),B=c.windowManager.open({title:"Insert/edit image",data:D,bodyType:"tabpanel",body:[{title:"General",type:"form",items:j},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:v},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:k})):B=c.windowManager.open({title:"Edit image",data:D,body:j,onSubmit:k})}c.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:d(a),stateSelector:"img:not([data-mce-object])"}),c.addMenuItem("image",{icon:"image",text:"Insert image",onclick:d(a),context:"insert",prependToContext:!0})});