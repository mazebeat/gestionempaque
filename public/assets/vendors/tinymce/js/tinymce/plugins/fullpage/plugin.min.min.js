tinymce.PluginManager.add("fullpage",function(k){function w(){var a=g();k.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(c){j(tinymce.extend(a,c.data))}})}function g(){function c(o,i){var r=o.attr(i);return r||""}var l,a,d=q(),e={};return e.fontface=k.getParam("fullpage_default_fontface",""),e.fontsize=k.getParam("fullpage_default_fontsize",""),l=d.firstChild,7==l.type&&(e.xml_pi=!0,a=/encoding="([^"]+)"/.exec(l.value),a&&(e.docencoding=a[1])),l=d.getAll("#doctype")[0],l&&(e.doctype="<!DOCTYPE"+l.value+">"),l=d.getAll("title")[0],l&&l.firstChild&&(e.title=l.firstChild.value),v(d.getAll("meta"),function(s){var r,u=s.attr("name"),o=s.attr("http-equiv");u?e[u.toLowerCase()]=s.attr("content"):"Content-Type"==o&&(r=/charset\s*=\s*(.*)\s*/gi.exec(s.attr("content")),r&&(e.docencoding=r[1]))}),l=d.getAll("html")[0],l&&(e.langcode=c(l,"lang")||c(l,"xml:lang")),l=d.getAll("link")[0],l&&"stylesheet"==l.attr("rel")&&(e.stylesheet=l.attr("href")),l=d.getAll("body")[0],l&&(e.langdir=c(l,"dir"),e.style=c(l,"style"),e.visited_color=c(l,"vlink"),e.link_color=c(l,"link"),e.active_color=c(l,"alink")),e}function j(B){function e(i,c,l){i.attr(c,l?l:void 0)}function y(c){d.firstChild?d.insert(c,d.firstChild):d.append(c)}var a,d,u,A,s,z=k.dom;a=q(),d=a.getAll("head")[0],d||(A=a.getAll("html")[0],d=new m("head",1),A.firstChild?A.insert(d,A.firstChild,!0):A.append(d)),A=a.firstChild,B.xml_pi?(s='version="1.0"',B.docencoding&&(s+=' encoding="'+B.docencoding+'"'),7!=A.type&&(A=new m("xml",7),a.insert(A,a.firstChild,!0)),A.value=s):A&&7==A.type&&A.remove(),A=a.getAll("#doctype")[0],B.doctype?(A||(A=new m("#doctype",10),B.xml_pi?a.insert(A,a.firstChild):y(A)),A.value=B.doctype.substring(9,B.doctype.length-1)):A&&A.remove(),B.docencoding&&(A=null,v(a.getAll("meta"),function(c){"Content-Type"==c.attr("http-equiv")&&(A=c)}),A||(A=new m("meta",1),A.attr("http-equiv","Content-Type"),A.shortEnded=!0,y(A)),A.attr("content","text/html; charset="+B.docencoding)),A=a.getAll("title")[0],B.title?A||(A=new m("title",1),A.append(new m("#text",3)).value=B.title,y(A)):A&&A.remove(),v("keywords,description,author,copyright,robots".split(","),function(r){var C,i,t=a.getAll("meta"),c=B[r];for(C=0;C<t.length;C++){if(i=t[C],i.attr("name")==r){return c?i.attr("content",c):i.remove(),void 0}}c&&(A=new m("meta",1),A.attr("name",r),A.attr("content",c),A.shortEnded=!0,y(A))}),A=a.getAll("link")[0],A&&"stylesheet"==A.attr("rel")?B.stylesheet?A.attr("href",B.stylesheet):A.remove():B.stylesheet&&(A=new m("link",1),A.attr({rel:"stylesheet",text:"text/css",href:B.stylesheet}),A.shortEnded=!0,y(A)),A=a.getAll("body")[0],A&&(e(A,"dir",B.langdir),e(A,"style",B.style),e(A,"vlink",B.visited_color),e(A,"link",B.link_color),e(A,"alink",B.active_color),z.setAttribs(k.getBody(),{style:B.style,dir:B.dir,vLink:B.visited_color,link:B.link_color,aLink:B.active_color})),A=a.getAll("html")[0],A&&(e(A,"lang",B.langcode),e(A,"xml:lang",B.langcode)),d.firstChild||d.remove(),u=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(a),x=u.substring(0,u.indexOf("</body>"))}function q(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(x)}function b(A){function c(d){return d.replace(/<\/?[A-Z]+/g,function(i){return i.toLowerCase()})}var s,a,o,z,e=A.content,y="",u=k.dom;A.selection||"raw"==A.format&&x||A.source_view&&k.getParam("fullpage_hide_in_source_view")||(e=e.replace(/<(\/?)BODY/gi,"<$1body"),s=e.indexOf("<body"),-1!=s?(s=e.indexOf(">",s),x=c(e.substring(0,s+1)),a=e.indexOf("</body",s),-1==a&&(a=e.length),A.content=e.substring(s+1,a),p=c(e.substring(a))):(x=f(),p="\n</body>\n</html>"),o=q(),v(o.getAll("style"),function(d){d.firstChild&&(y+=d.firstChild.value)}),z=o.getAll("body")[0],z&&u.setAttribs(k.getBody(),{style:z.attr("style")||"",dir:z.attr("dir")||"",vLink:z.attr("vlink")||"",link:z.attr("link")||"",aLink:z.attr("alink")||""}),u.remove("fullpage_styles"),y&&(u.add(k.getDoc().getElementsByTagName("head")[0],"style",{id:"fullpage_styles"},y),z=u.get("fullpage_styles"),z.styleSheet&&(z.styleSheet.cssText=y)))}function f(){var c,d="",a="";return k.getParam("fullpage_default_xml_pi")&&(d+='<?xml version="1.0" encoding="'+k.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),d+=k.getParam("fullpage_default_doctype","<!DOCTYPE html>"),d+="\n<html>\n<head>\n",(c=k.getParam("fullpage_default_title"))&&(d+="<title>"+c+"</title>\n"),(c=k.getParam("fullpage_default_encoding"))&&(d+='<meta http-equiv="Content-Type" content="text/html; charset='+c+'" />\n'),(c=k.getParam("fullpage_default_font_family"))&&(a+="font-family: "+c+";"),(c=k.getParam("fullpage_default_font_size"))&&(a+="font-size: "+c+";"),(c=k.getParam("fullpage_default_text_color"))&&(a+="color: "+c+";"),d+="</head>\n<body"+(a?' style="'+a+'"':"")+">\n"}function h(a){a.selection||a.source_view&&k.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(x)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(p))}var x,p,v=tinymce.each,m=tinymce.html.Node;k.addCommand("mceFullPageProperties",w),k.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),k.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),k.on("BeforeSetContent",b),k.on("GetContent",h)});