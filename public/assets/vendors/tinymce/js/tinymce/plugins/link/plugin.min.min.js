tinymce.PluginManager.add("link",function(b){function a(d){return function(){var e=b.settings.link_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(f){d(tinymce.util.JSON.parse(f))}}):d(e)}}function c(H){function q(f){var d=C.find("#text");(!d.value()||f.lastControl&&d.value()==f.lastControl.text())&&d.value(f.control.text()),C.find("#href").value(f.control.value())}function y(){var d=[{text:"None",value:""}];return tinymce.each(H,function(f){d.push({text:f.text||f.title,value:f.value||f.url,menu:f.menu})}),d}function E(d){var f=[{text:"None",value:""}];return tinymce.each(b.settings.rel_list,function(g){f.push({text:g.text||g.title,value:g.value,selected:d===g.value})}),f}function k(d){var f=[{text:"None",value:""}];return b.settings.target_list||f.push({text:"New window",value:"_blank"}),tinymce.each(b.settings.target_list,function(g){f.push({text:g.text||g.title,value:g.value,selected:d===g.value})}),f}function e(f){var d=[];return tinymce.each(b.dom.select("a:not([href])"),function(g){var h=g.name||g.id;h&&d.push({text:h,value:"#"+h,selected:-1!=f.indexOf("#"+h)})}),d.length?(d.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:d,onselect:q}):void 0}function I(){D||0!==A.text.length||this.parent().parent().find("#text")[0].value(this.value())}var x,G,D,C,w,B,z,A={},j=b.selection,F=b.dom;x=j.getNode(),G=F.getParent(x,"a[href]"),A.text=D=G?G.innerText||G.textContent:j.getContent({format:"text"}),A.href=G?F.getAttrib(G,"href"):"",A.target=G?F.getAttrib(G,"target"):"",A.rel=G?F.getAttrib(G,"rel"):"","IMG"==x.nodeName&&(A.text=D=" "),H&&(w={type:"listbox",label:"Link list",values:y(),onselect:q}),b.settings.target_list!==!1&&(z={name:"target",type:"listbox",label:"Target",values:k(A.target)}),b.settings.rel_list&&(B={name:"rel",type:"listbox",label:"Rel",values:E(A.rel)}),C=b.windowManager.open({title:"Insert link",data:A,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:I,onkeyup:I},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){A.text=this.value()}},e(A.href),w,B,z],onSubmit:function(g){function l(i,m){window.setTimeout(function(){b.windowManager.confirm(i,m)},0)}function f(){d.text!=D?G?(b.focus(),G.innerHTML=d.text,F.setAttribs(G,{href:h,target:d.target?d.target:null,rel:d.rel?d.rel:null}),j.select(G)):b.insertContent(F.createHTML("a",{href:h,target:d.target?d.target:null,rel:d.rel?d.rel:null},d.text)):b.execCommand("mceInsertLink",!1,{href:h,target:d.target,rel:d.rel?d.rel:null})}var d=g.data,h=d.href;return h?h.indexOf("@")>0&&-1==h.indexOf("//")&&-1==h.indexOf("mailto:")?(l("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(i){i&&(h="mailto:"+h),f()}),void 0):/^\s*www\./i.test(h)?(l("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(i){i&&(h="http://"+h),f()}),void 0):(f(),void 0):(b.execCommand("unlink"),void 0)}})}b.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:a(c),stateSelector:"a[href]"}),b.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),b.addShortcut("Ctrl+K","",a(c)),this.showDialog=c,b.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:a(c),stateSelector:"a[href]",context:"insert",prependToContext:!0})});