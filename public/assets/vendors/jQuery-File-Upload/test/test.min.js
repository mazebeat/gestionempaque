$(function(){QUnit.done=function(){var c=$("#fileupload").prop("action");$.getJSON(c,function(d){$.each(d.files,function(e,f){$.ajax({url:c+"?file="+encodeURIComponent(f.name),type:"DELETE"})})})};var a={setup:function(){$.widget("blueimp.fileupload",window.testBasicWidget,{})},teardown:function(){$(document).unbind()}},b={setup:function(){$.widget("blueimp.fileupload",window.testUIWidget,{})},teardown:function(){$(document).unbind()}};module("Initialization",a);test("Widget initialization",function(){var c=$("#fileupload").fileupload();ok(c.data("blueimp-fileupload")||c.data("fileupload"))});test("Data attribute options",function(){$("#fileupload").attr("data-url","http://example.org");$("#fileupload").fileupload();strictEqual($("#fileupload").fileupload("option","url"),"http://example.org")});test("File input initialization",function(){var c=$("#fileupload").fileupload();ok(c.fileupload("option","fileInput").length,"File input field inside of the widget");ok(c.fileupload("option","fileInput").length,"Widget element as file input field")});test("Drop zone initialization",function(){ok($("#fileupload").fileupload().fileupload("option","dropZone").length)});test("Paste zone initialization",function(){ok($("#fileupload").fileupload().fileupload("option","pasteZone").length)});test("Event listeners initialization",function(){expect($.support.xhrFormDataFileUpload?4:1);var c={originalEvent:{dataTransfer:{files:[{}],types:["Files"]},clipboardData:{items:[{}]}}},g=$("#fileupload").fileupload({dragover:function(){ok(true,"Triggers dragover callback");return false},drop:function(){ok(true,"Triggers drop callback");return false},paste:function(){ok(true,"Triggers paste callback");return false},change:function(){ok(true,"Triggers change callback");return false}}),d=g.fileupload("option","fileInput"),f=g.fileupload("option","dropZone"),e=g.fileupload("option","pasteZone");d.trigger($.Event("change",c));f.trigger($.Event("dragover",c));f.trigger($.Event("drop",c));e.trigger($.Event("paste",c))});module("API",a);test("destroy",function(){expect(4);var c={originalEvent:{dataTransfer:{files:[{}],types:["Files"]},clipboardData:{items:[{}]}}},d={dragover:function(){ok(true,"Triggers dragover callback");return false},drop:function(){ok(true,"Triggers drop callback");return false},paste:function(){ok(true,"Triggers paste callback");return false},change:function(){ok(true,"Triggers change callback");return false}},h=$("#fileupload").fileupload(d),e=h.fileupload("option","fileInput"),g=h.fileupload("option","dropZone"),f=h.fileupload("option","pasteZone");g.bind("dragover",d.dragover);g.bind("drop",d.drop);f.bind("paste",d.paste);e.bind("change",d.change);h.fileupload("destroy");e.trigger($.Event("change",c));g.trigger($.Event("dragover",c));g.trigger($.Event("drop",c));f.trigger($.Event("paste",c))});test("disable/enable",function(){expect($.support.xhrFormDataFileUpload?4:1);var c={originalEvent:{dataTransfer:{files:[{}],types:["Files"]},clipboardData:{items:[{}]}}},g=$("#fileupload").fileupload({dragover:function(){ok(true,"Triggers dragover callback");return false},drop:function(){ok(true,"Triggers drop callback");return false},paste:function(){ok(true,"Triggers paste callback");return false},change:function(){ok(true,"Triggers change callback");return false}}),d=g.fileupload("option","fileInput"),f=g.fileupload("option","dropZone"),e=g.fileupload("option","pasteZone");g.fileupload("disable");d.trigger($.Event("change",c));f.trigger($.Event("dragover",c));f.trigger($.Event("drop",c));e.trigger($.Event("paste",c));g.fileupload("enable");d.trigger($.Event("change",c));f.trigger($.Event("dragover",c));f.trigger($.Event("drop",c));e.trigger($.Event("paste",c))});test("option",function(){expect($.support.xhrFormDataFileUpload?10:7);var c={originalEvent:{dataTransfer:{files:[{}],types:["Files"]},clipboardData:{items:[{}]}}},g=$("#fileupload").fileupload({dragover:function(){ok(true,"Triggers dragover callback");return false},drop:function(){ok(true,"Triggers drop callback");return false},paste:function(){ok(true,"Triggers paste callback");return false},change:function(){ok(true,"Triggers change callback");return false}}),d=g.fileupload("option","fileInput"),f=g.fileupload("option","dropZone"),e=g.fileupload("option","pasteZone");g.fileupload("option","fileInput",null);g.fileupload("option","dropZone",null);g.fileupload("option","pasteZone",null);d.trigger($.Event("change",c));f.trigger($.Event("dragover",c));f.trigger($.Event("drop",c));e.trigger($.Event("paste",c));g.fileupload("option","dropZone","body");strictEqual(g.fileupload("option","dropZone")[0],document.body,"Allow a query string as parameter for the dropZone option");g.fileupload("option","dropZone",document);strictEqual(g.fileupload("option","dropZone")[0],document,"Allow a document element as parameter for the dropZone option");g.fileupload("option","pasteZone","body");strictEqual(g.fileupload("option","pasteZone")[0],document.body,"Allow a query string as parameter for the pasteZone option");g.fileupload("option","pasteZone",document);strictEqual(g.fileupload("option","pasteZone")[0],document,"Allow a document element as parameter for the pasteZone option");g.fileupload("option","fileInput",":file");strictEqual(g.fileupload("option","fileInput")[0],$(":file")[0],"Allow a query string as parameter for the fileInput option");g.fileupload("option","fileInput",$(":file")[0]);strictEqual(g.fileupload("option","fileInput")[0],$(":file")[0],"Allow a document element as parameter for the fileInput option");g.fileupload("option","fileInput",d);g.fileupload("option","dropZone",f);g.fileupload("option","pasteZone",e);d.trigger($.Event("change",c));f.trigger($.Event("dragover",c));f.trigger($.Event("drop",c));e.trigger($.Event("paste",c))});asyncTest("add",function(){expect(2);var c={files:[{name:"test"}]};$("#fileupload").fileupload({add:function(f,d){strictEqual(d.files[0].name,c.files[0].name,"Triggers add callback")}}).fileupload("add",c).fileupload("option","add",function(f,d){d.submit().complete(function(){ok(true,"data.submit() Returns a jqXHR object");start()})}).fileupload("add",c)});asyncTest("send",function(){expect(3);var c={files:[{name:"test"}]};$("#fileupload").fileupload({send:function(f,d){strictEqual(d.files[0].name,"test","Triggers send callback")}}).fileupload("send",c).fail(function(){ok(true,"Allows to abort the request")}).complete(function(){ok(true,"Returns a jqXHR object");start()}).abort()});module("Callbacks",a);asyncTest("add",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({add:function(){ok(true,"Triggers add callback");start()}}).fileupload("add",c)});asyncTest("submit",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({submit:function(){ok(true,"Triggers submit callback");start();return false}}).fileupload("add",c)});asyncTest("send",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({send:function(){ok(true,"Triggers send callback");start();return false}}).fileupload("send",c)});asyncTest("done",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({done:function(){ok(true,"Triggers done callback");start()}}).fileupload("send",c)});asyncTest("fail",function(){expect(1);var d={files:[{name:"test"}]},c=$("#fileupload").fileupload({url:"404",fail:function(){ok(true,"Triggers fail callback");start()}});(c.data("blueimp-fileupload")||c.data("fileupload"))._isXHRUpload=function(){return true};c.fileupload("send",d)});asyncTest("always",function(){expect(2);var e={files:[{name:"test"}]},c=0,d=$("#fileupload").fileupload({always:function(){ok(true,"Triggers always callback");if(c===1){start()}else{c+=1}}});(d.data("blueimp-fileupload")||d.data("fileupload"))._isXHRUpload=function(){return true};d.fileupload("add",e).fileupload("option","url","404").fileupload("add",e)});asyncTest("progress",function(){expect(1);var d={files:[{name:"test"}]},c=0;$("#fileupload").fileupload({forceIframeTransport:true,progress:function(){ok(true,"Triggers progress callback");if(c===0){start()}else{c+=1}}}).fileupload("send",d)});asyncTest("progressall",function(){expect(1);var d={files:[{name:"test"}]},c=0;$("#fileupload").fileupload({forceIframeTransport:true,progressall:function(){ok(true,"Triggers progressall callback");if(c===0){start()}else{c+=1}}}).fileupload("send",d)});asyncTest("start",function(){expect(1);var d={files:[{name:"1"},{name:"2"}]},c=0;$("#fileupload").fileupload({send:function(){c+=1},start:function(){ok(!c,"Triggers start callback before uploads");start()}}).fileupload("send",d)});asyncTest("stop",function(){expect(1);var d={files:[{name:"1"},{name:"2"}]},c=0;$("#fileupload").fileupload({send:function(){c+=1},always:function(){c-=1},stop:function(){ok(!c,"Triggers stop callback after uploads");start()}}).fileupload("send",d)});test("change",function(){var e=$("#fileupload").fileupload(),c=e.data("blueimp-fileupload")||e.data("fileupload"),d=e.fileupload("option","fileInput");expect(2);e.fileupload({change:function(g,f){ok(true,"Triggers change callback");strictEqual(f.files.length,0,"Returns empty files list")},add:$.noop});c._onChange({data:{fileupload:c},target:d[0]})});test("paste",function(){var d=$("#fileupload").fileupload(),c=d.data("blueimp-fileupload")||d.data("fileupload");expect(1);d.fileupload({paste:function(){ok(true,"Triggers paste callback")},add:$.noop});c._onPaste({data:{fileupload:c},originalEvent:{dataTransfer:{files:[{}]},clipboardData:{items:[{}]}},preventDefault:$.noop})});test("drop",function(){var d=$("#fileupload").fileupload(),c=d.data("blueimp-fileupload")||d.data("fileupload");expect(1);d.fileupload({drop:function(){ok(true,"Triggers drop callback")},add:$.noop});c._onDrop({data:{fileupload:c},originalEvent:{dataTransfer:{files:[{}]},clipboardData:{items:[{}]}},preventDefault:$.noop})});test("dragover",function(){var d=$("#fileupload").fileupload(),c=d.data("blueimp-fileupload")||d.data("fileupload");expect(1);d.fileupload({dragover:function(){ok(true,"Triggers dragover callback")},add:$.noop});c._onDragOver({data:{fileupload:c},originalEvent:{dataTransfer:{types:["Files"]}},preventDefault:$.noop})});module("Options",a);test("paramName",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({paramName:null,send:function(f,d){strictEqual(d.paramName[0],d.fileInput.prop("name"),"Takes paramName from file input field if not set");return false}}).fileupload("send",c)});test("url",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({url:null,send:function(f,d){strictEqual(d.url,$(d.fileInput.prop("form")).prop("action"),"Takes url from form action if not set");return false}}).fileupload("send",c)});test("type",function(){expect(2);var c={files:[{name:"test"}]};$("#fileupload").fileupload({type:null,send:function(f,d){strictEqual(d.type,"POST",'Request type is "POST" if not set to "PUT"');return false}}).fileupload("send",c);$("#fileupload").fileupload({type:"PUT",send:function(f,d){strictEqual(d.type,"PUT",'Request type is "PUT" if set to "PUT"');return false}}).fileupload("send",c)});test("replaceFileInput",function(){var f=$("#fileupload").fileupload(),c=f.data("blueimp-fileupload")||f.data("fileupload"),d=f.fileupload("option","fileInput"),e=d[0];expect(2);f.fileupload({replaceFileInput:false,change:function(){strictEqual(f.fileupload("option","fileInput")[0],e,"Keeps file input with replaceFileInput: false")},add:$.noop});c._onChange({data:{fileupload:c},target:d[0]});f.fileupload({replaceFileInput:true,change:function(){notStrictEqual(f.fileupload("option","fileInput")[0],e,"Replaces file input with replaceFileInput: true")},add:$.noop});c._onChange({data:{fileupload:c},target:d[0]})});asyncTest("forceIframeTransport",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({forceIframeTransport:true,done:function(f,d){strictEqual(d.dataType.substr(0,6),"iframe","Iframe Transport is used");start()}}).fileupload("send",c)});test("singleFileUploads",function(){expect(3);var e=$("#fileupload").fileupload(),d={files:[{name:"1"},{name:"2"}]},c=1;(e.data("blueimp-fileupload")||e.data("fileupload"))._isXHRUpload=function(){return true};$("#fileupload").fileupload({singleFileUploads:true,add:function(){ok(true,"Triggers callback number "+c.toString());c+=1}}).fileupload("add",d).fileupload("option","singleFileUploads",false).fileupload("add",d)});test("limitMultiFileUploads",function(){expect(3);var e=$("#fileupload").fileupload(),d={files:[{name:"1"},{name:"2"},{name:"3"},{name:"4"},{name:"5"}]},c=1;(e.data("blueimp-fileupload")||e.data("fileupload"))._isXHRUpload=function(){return true};$("#fileupload").fileupload({singleFileUploads:false,limitMultiFileUploads:2,add:function(){ok(true,"Triggers callback number "+c.toString());c+=1}}).fileupload("add",d)});test("limitMultiFileUploadSize",function(){expect(7);var f=$("#fileupload").fileupload(),e={files:[{name:"1-1",size:100000},{name:"1-2",size:40000},{name:"2-1",size:100000},{name:"3-1",size:50000},{name:"3-2",size:40000},{name:"4-1",size:45000}]},d={files:[{name:"5-1"},{name:"5-2"},{name:"6-1"},{name:"6-2"},{name:"7-1"}]},c=1;(f.data("blueimp-fileupload")||f.data("fileupload"))._isXHRUpload=function(){return true};$("#fileupload").fileupload({singleFileUploads:false,limitMultiFileUploads:2,limitMultiFileUploadSize:150000,limitMultiFileUploadSizeOverhead:5000,add:function(){ok(true,"Triggers callback number "+c.toString());c+=1}}).fileupload("add",e).fileupload("add",d)});asyncTest("sequentialUploads",function(){expect(6);var g={files:[{name:"1"},{name:"2"},{name:"3"},{name:"4"},{name:"5"},{name:"6"}]},d=0,e=0,c=0,f=$("#fileupload").fileupload({sequentialUploads:true,add:function(i,h){d+=1;if(d===4){h.submit().abort()}else{h.submit()}},send:function(){e+=1},done:function(){c+=1;strictEqual(e,c,"upload in order")},fail:function(i,h){strictEqual(h.errorThrown,"abort","upload aborted")},stop:function(){start()}});(f.data("blueimp-fileupload")||f.data("fileupload"))._isXHRUpload=function(){return true};f.fileupload("add",g)});asyncTest("limitConcurrentUploads",function(){expect(12);var g={files:[{name:"1"},{name:"2"},{name:"3"},{name:"4"},{name:"5"},{name:"6"},{name:"7"},{name:"8"},{name:"9"},{name:"10"},{name:"11"},{name:"12"}]},d=0,e=0,c=0,f=$("#fileupload").fileupload({limitConcurrentUploads:3,add:function(i,h){d+=1;if(d===4){h.submit().abort()}else{h.submit()}},send:function(){e+=1},done:function(){c+=1;ok(e-c<3)},fail:function(i,h){strictEqual(h.errorThrown,"abort","upload aborted")},stop:function(){start()}});(f.data("blueimp-fileupload")||f.data("fileupload"))._isXHRUpload=function(){return true};f.fileupload("add",g)});if($.support.xhrFileUpload){asyncTest("multipart",function(){expect(2);var d={files:[{name:"test.png",size:123,type:"image/png"}]},c=$("#fileupload").fileupload({multipart:false,always:function(g,f){strictEqual(f.contentType,d.files[0].type,"non-multipart upload sets file type as contentType");strictEqual(f.headers["Content-Disposition"],'attachment; filename="'+d.files[0].name+'"',"non-multipart upload sets Content-Disposition header");start()}});c.fileupload("send",d)})}module("UI Initialization",b);test("Widget initialization",function(){var c=$("#fileupload").fileupload();ok(c.data("blueimp-fileupload")||c.data("fileupload"));ok($("#fileupload").fileupload("option","uploadTemplate").length,"Initialized upload template");ok($("#fileupload").fileupload("option","downloadTemplate").length,"Initialized download template")});test("Buttonbar event listeners",function(){var d=$("#fileupload .fileupload-buttonbar"),c=[{name:"test"}];expect(4);$("#fileupload").fileupload({send:function(){ok(true,"Started file upload via global start button")},fail:function(g,f){ok(true,"Canceled file upload via global cancel button");f.context.remove()},destroy:function(){ok(true,"Delete action called via global delete button")}});$("#fileupload").fileupload("add",{files:c});d.find(".cancel").click();$("#fileupload").fileupload("add",{files:c});d.find(".start").click();d.find(".cancel").click();c[0].deleteUrl="http://example.org/banana.jpg";($("#fileupload").data("blueimp-fileupload")||$("#fileupload").data("fileupload"))._renderDownload(c).appendTo($("#fileupload .files")).show().find(".toggle").click();d.find(".delete").click()});module("UI API",b);test("destroy",function(){var d=$("#fileupload .fileupload-buttonbar"),c=[{name:"test"}];expect(1);$("#fileupload").fileupload({send:function(){ok(true,"This test should not run");return false}}).fileupload("add",{files:c}).fileupload("destroy");d.find(".start").click(function(){ok(true,"Clicked global start button");return false}).click()});test("disable/enable",function(){var c=$("#fileupload .fileupload-buttonbar");$("#fileupload").fileupload();$("#fileupload").fileupload("disable");strictEqual(c.find("input[type=file], button").not(":disabled").length,0,"Disables the buttonbar buttons");$("#fileupload").fileupload("enable");strictEqual(c.find("input[type=file], button").not(":disabled").length,4,"Enables the buttonbar buttons")});module("UI Callbacks",b);test("destroy",function(){expect(3);$("#fileupload").fileupload({destroy:function(d,c){ok(true,"Triggers destroy callback");strictEqual(c.url,"test","Passes over deletion url parameter");strictEqual(c.type,"DELETE","Passes over deletion request type parameter")}});($("#fileupload").data("blueimp-fileupload")||$("#fileupload").data("fileupload"))._renderDownload([{name:"test",deleteUrl:"test",deleteType:"DELETE"}]).appendTo($("#fileupload .files")).show().find(".toggle").click();$("#fileupload .fileupload-buttonbar .delete").click()});asyncTest("added",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({added:function(f,d){start();strictEqual(d.files[0].name,c.files[0].name,"Triggers added callback")},send:function(){return false}}).fileupload("add",c)});asyncTest("started",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({started:function(){start();ok("Triggers started callback");return false},sent:function(){return false}}).fileupload("send",c)});asyncTest("sent",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({sent:function(f,d){start();strictEqual(d.files[0].name,c.files[0].name,"Triggers sent callback");return false}}).fileupload("send",c)});asyncTest("completed",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({completed:function(){start();ok("Triggers completed callback");return false}}).fileupload("send",c)});asyncTest("failed",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({failed:function(){start();ok("Triggers failed callback");return false}}).fileupload("send",c).abort()});asyncTest("stopped",function(){expect(1);var c={files:[{name:"test"}]};$("#fileupload").fileupload({stopped:function(){start();ok("Triggers stopped callback");return false}}).fileupload("send",c)});asyncTest("destroyed",function(){expect(1);$("#fileupload").fileupload({dataType:"html",destroyed:function(){start();ok(true,"Triggers destroyed callback")}});($("#fileupload").data("blueimp-fileupload")||$("#fileupload").data("fileupload"))._renderDownload([{name:"test",deleteUrl:".",deleteType:"GET"}]).appendTo($("#fileupload .files")).show().find(".toggle").click();$("#fileupload .fileupload-buttonbar .delete").click()});module("UI Options",b);test("autoUpload",function(){expect(1);$("#fileupload").fileupload({autoUpload:true,send:function(){ok(true,"Started file upload automatically");return false}}).fileupload("add",{files:[{name:"test"}]}).fileupload("option","autoUpload",false).fileupload("add",{files:[{name:"test"}]})});test("maxNumberOfFiles",function(){expect(3);var c=0,d=0;$("#fileupload").fileupload({autoUpload:true,maxNumberOfFiles:3,singleFileUploads:false,send:function(){strictEqual(d+=1,c)},progress:$.noop,progressall:$.noop,done:$.noop,stop:$.noop}).fileupload("add",{files:[{name:(c+=1)}]}).fileupload("add",{files:[{name:(c+=1)}]}).fileupload("add",{files:[{name:(c+=1)}]}).fileupload("add",{files:[{name:"test"}]})});test("maxFileSize",function(){expect(2);var c=0,d=0;$("#fileupload").fileupload({autoUpload:true,maxFileSize:1000,send:function(){strictEqual(d+=1,c);return false}}).fileupload("add",{files:[{name:(c+=1)}]}).fileupload("add",{files:[{name:(c+=1),size:999}]}).fileupload("add",{files:[{name:"test",size:1001}]}).fileupload({send:function(g,f){ok(!$.blueimp.fileupload.prototype.options.send.call(this,g,f));return false}})});test("minFileSize",function(){expect(2);var c=0,d=0;$("#fileupload").fileupload({autoUpload:true,minFileSize:1000,send:function(){strictEqual(d+=1,c);return false}}).fileupload("add",{files:[{name:(c+=1)}]}).fileupload("add",{files:[{name:(c+=1),size:1001}]}).fileupload("add",{files:[{name:"test",size:999}]}).fileupload({send:function(g,f){ok(!$.blueimp.fileupload.prototype.options.send.call(this,g,f));return false}})});test("acceptFileTypes",function(){expect(2);var c=0,d=0;$("#fileupload").fileupload({autoUpload:true,acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,disableImageMetaDataLoad:true,send:function(){strictEqual(d+=1,c);return false}}).fileupload("add",{files:[{name:(c+=1)+".jpg"}]}).fileupload("add",{files:[{name:(c+=1),type:"image/jpeg"}]}).fileupload("add",{files:[{name:"test.txt",type:"text/plain"}]}).fileupload({send:function(g,f){ok(!$.blueimp.fileupload.prototype.options.send.call(this,g,f));return false}})});test("acceptFileTypes as HTML5 data attribute",function(){expect(2);var c=/(\.|\/)(gif|jpe?g|png)$/i;$("#fileupload").attr("data-accept-file-types",c.toString()).fileupload();strictEqual($.type($("#fileupload").fileupload("option","acceptFileTypes")),$.type(c));strictEqual($("#fileupload").fileupload("option","acceptFileTypes").toString(),c.toString())})});